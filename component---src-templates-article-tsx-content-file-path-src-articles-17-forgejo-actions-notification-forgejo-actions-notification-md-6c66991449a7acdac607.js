"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[829],{3143:function(e,t,n){n.r(t),n.d(t,{Head:function(){return H},default:function(){return I}});var o=n(8453),l=n(6540),a=n.p+"static/architecture-75c08cf2452241c33e732a36b13cb723.svg",r=n.p+"static/release_notes-483e208cb6fa63b93c26d17225aac5b5.png",i=n.p+"static/webhook_settings-34214e7b1e30e8d570eee5e181dd1451.png";function s(e){const t=Object.assign({p:"p",a:"a",ul:"ul",li:"li",code:"code",h2:"h2",span:"span",pre:"pre",em:"em",h3:"h3",ol:"ol"},(0,o.R)(),e.components),{HalfImage:n,Iframe:s,Spacer:c}=t;return n||u("HalfImage",!0),s||u("Iframe",!0),c||u("Spacer",!0),l.createElement(l.Fragment,null,l.createElement(t.p,null,"This article is about Forgejo, a code forge:\nJust like GitHub or GitLab it's a place to (collaboratively) develop software.\nI've already explained at length ",l.createElement(t.a,{href:"/articles/open_source"},"why we benefit greatly from Open-Source"),".\nMotivated by that concept, Forgejo's amazing community and perhaps because it's incredibly easy to set up, you select it for your private code forge.\nThough, with your Forgejo instance up and running you might miss a few features.\nI, for example, needed to receive email notifications and webhooks when a CI Workflow failed.\nForgejo didn't offer that feature so I started contributing.\nYou might find yourself in those shoes, too.\nIn this article I want to help you on that journey and give my experience contributing to Forgejo.\nThe parts that took the most effort where"),"\n",l.createElement(t.ul,null,"\n",l.createElement(t.li,null,"setting up a development environment,"),"\n",l.createElement(t.li,null,"understanding Forgejo's notification architecture,"),"\n",l.createElement(t.li,null,"actually implementing the features and"),"\n",l.createElement(t.li,null,"writing exhaustive tests for the features I implemented."),"\n"),"\n",l.createElement(t.p,null,"Be aware that I'm describing all of this as of commit ",l.createElement(t.code,null,"b2c4fc9f94")," from 21st July 2025.\nSome of this information may be outdated by the time you read it."),"\n",l.createElement(t.h2,{id:"any-go-projects-directory-structure",style:{position:"relative"}},l.createElement(t.a,{href:"#any-go-projects-directory-structure","aria-label":"any go projects directory structure permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Any Go Project's Directory Structure"),"\n",l.createElement(t.p,null,"Firstly we need to take a look behind Forgejo's pretty curtain:\nForgejo uses Go for its backend.\nI've always found Go's module system illusive, especially its use of domains as module paths.\nAlso, Go does a lot of things implicitly, for example:\nHow do you tell Go that some function is a unit test?\nYou place it in a file with the ",l.createElement(t.code,null,"_test.go")," suffix.\nOr another one:\nHow do you declare a symbol to be exported or not-exported (analogous to public or private in other languages)?\nThere's no keyword for that.\nInstead, symbols with a leading capital letter are implicitly exported, otherwise not.\nThose things are hard to figure out if you haven't inhaled the Go docs and just read through a project for the first time.\nTherefore, I want to quickly explain how Go handles dependencies.\nThere also is an ",l.createElement(t.a,{href:"https://go.dev/doc/modules/managing-dependencies"},"official generic explanation")," if you prefer that."),"\n",l.createElement(t.p,null,"Okay, so, you find Forgejo's source code on ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo"},"codeberg.org/forgejo/forgejo"),".\nIn this section we'll concern ourself with this subsection of Forgejo's files:"),"\n",l.createElement(t.pre,null,l.createElement(t.code,null,"/\n├── go.mod\n├── main.go\n├── cmd\n│   └─ main.go\n└── modules\n    └─ log\n       └─ init.go\n")),"\n",l.createElement(t.p,null,"Firstly, there are modules.\nA Go library is a module, a Go executable too.\nTypically one git repo houses a single Go module.\nForgejo is a binary Go module with the module path ",l.createElement(t.code,null,"forgejo.org"),".\nWe can figure that out by looking at its ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/src/branch/forgejo/go.mod"},l.createElement(t.code,null,"go.mod"))," file."),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},"// /go.mod\nmodule forgejo.org\n// --snip--\nrequire (\n    // --snip--\n    github.com/hashicorp/go-version v1.7.0\n// --snip--\nreplace github.com/hashicorp/go-version => github.com/6543/go-version v1.3.1\n// --snip--\n")),"\n",l.createElement(t.p,null,"We notice that Forgejo uses the ",l.createElement(t.code,null,"github.com/hashicorp/go-version")," Go module.\nThat's a dependency, which the Go tools will download directly from GitHub.\nWe notice that Go uses a decentralized system for publishing modules:\nThere isn't some central package index like NPM, crates.io or PyPI.\nBecause Go identifies a module with these URL-like paths, you also need to use statements like ",l.createElement(t.code,null,"import github.com/hashicorp/go-version")," to import the dependency.\nConsequently, Forgejo's code is full of domains where dependencies should be pulled from.\nAnd that really annoyed me at first.\nDo you really have to touch possibly hundreds of files only when the dependency's git repo changes?\nWhile I'm still not entirely onboard, I'm slowly warming up to this decentralized system; mainly because of the ",l.createElement(t.code,null,"replace")," statement above.\nIt states that while the Forgejo's Go source code will ",l.createElement(t.code,null,"import github.com/hashicorp/go-version"),", the go tooling should download it from ",l.createElement(t.code,null,"github.com/6543/go-version"),", instead.\nIn this case Forgejo uses ",l.createElement(t.code,null,"replace")," to switch to a fork."),"\n",l.createElement(t.p,null,"As we've seen, Go code is grouped in modules but there's another level of granularity: packages.\nGo uses packages to isolate code into neat, contained, well, packages.\nEvery Go file declares what package they are in.\nGo code can use exported and not-exported symbols inside its own package (i.e., functions, values, etc.).\nTo use symbols in other packages, however, they must be exported and you need to import that other package.",l.createElement("br"),"\nThe package ",l.createElement(t.code,null,"main")," is special, that's where the entrypoint is.\nTake a look at Forgejo's ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/src/branch/forgejo/main.go"},l.createElement(t.code,null,"main.go")),":"),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},'// /main.go\n// --snip--\npackage main\nimport (\n    // [standard library imports]\n    "os"\n    "runtime"\n    // --snip--\n\n    // [import some other package from the Forgejo source code repo]\n    "forgejo.org/cmd"\n// --snip--\n)\n// --snip--\nfunc main() {\n    // --snip--\n')),"\n",l.createElement(t.p,null,"Now, this is what really confused me at first:\n",l.createElement(t.code,null,"forgejo.org")," is a domain you can visit with your browser but that's more or less just a coincidence.\nGo only uses it to identify Forgejo's main package's path.\nTherefore, ",l.createElement(t.code,null,"forgejo.org/cmd")," is not a web endpoint at all, even though it might look like one.\nInstead, it refers to the package ",l.createElement(t.code,null,"cmd")," located in the ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/src/branch/forgejo/cmd"},l.createElement(t.code,null,"/cmd")," directory"),"."),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},'// /cmd/main.go\n// --snip--\npackage cmd\n\nimport (\n    // --snip--\n    "forgejo.org/modules/log"\n    // --snip--\n    "github.com/urfave/cli/v3"\n// --snip--\n')),"\n",l.createElement(t.p,null,"And the ",l.createElement(t.code,null,"forgejo.org/cmd")," package imports some more packages.\nWhen you read this, be aware of the to-be-imported package's location in the directory structure.\nThe package lies in the ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/src/branch/forgejo/modules/log"},l.createElement(t.code,null,"/modules/log"))," directory of the ",l.createElement(t.code,null,"forgejo.org")," module, thus ",l.createElement(t.code,null,"forgejo.org/modules/log")," refers to it.\n",l.createElement(t.code,null,"github.com/urfave/cli/v3"),", however, refers to a dependency Go will download from GitHub during a build.\nThe imports look so similar but one is resolved locally and the other from the internet.",l.createElement("br"),"\nNotice that the Go files in the ",l.createElement(t.code,null,"forgejo.org/modules/log")," package declare their package without its full path:"),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},"// /modules/log/init.go\n// --snip--\npackage log\n// --snip--\n")),"\n",l.createElement(t.p,null,"It only says ",l.createElement(t.code,null,"log")," but the full package path required to import the package is ",l.createElement(t.code,null,"forgejo.org/modules/log"),".\nRemember how the directory Go code lies in influences any package's path."),"\n",l.createElement(t.h2,{id:"forgejos-layered-architecture",style:{position:"relative"}},l.createElement(t.a,{href:"#forgejos-layered-architecture","aria-label":"forgejos layered architecture permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Forgejo's Layered Architecture"),"\n",l.createElement(t.p,null,"This article is about implementing one specific feature, actions notifications.\nTherefore, I'll only talk about the parts of Forgejo's architecture that matter for this feature.\nFirstly, we take a look at Forgejo's layered ",l.createElement(t.a,{href:"https://forgejo.org/docs/next/contributor/architecture"},"architecture"),", which I've created a visualization of:"),"\n",l.createElement(n,{full:!0,src:a}),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"\\routers"),", ",l.createElement(t.code,null,"\\services"),", ",l.createElement(t.code,null,"\\models"),", ",l.createElement(t.code,null,"\\modules")," and ",l.createElement(t.code,null,"\\templates")," are the ",l.createElement(t.em,null,"main directories")," where most of Forgejo's Go code lives.\nAs we can see, there are three layers.\nFirstly, all code may access packages inside their respective main directory.\nThe code in the bottom layer, however, don't have access to anything else.\nSo for example, code in ",l.createElement(t.code,null,"\\modules")," may not access the Forgejo-specific database models defined in ",l.createElement(t.code,null,"\\models"),".\n(The Go compiler doesn't enforce this, code reviewers do.)\nPackages in ",l.createElement(t.code,null,"\\modules")," could theoretically be used as a library outside of Forgejo.\nSecondly, the ",l.createElement(t.code,null,"\\services")," module may access other ",l.createElement(t.code,null,"\\services")," and both ",l.createElement(t.code,null,"\\models")," and ",l.createElement(t.code,null,"\\modules")," but not the ",l.createElement(t.code,null,"\\routers")," above.\nFinally, the ",l.createElement(t.code,null,"\\routers")," code may use everything below it.",l.createElement("br"),"\nThere are other main directories that we don't care about.\nFurthermore, I've only drawn example packages, files and structs inside the main directories.\nThey contain a lot more things; things we'll look at later.\nLastly, the ",l.createElement(t.code,null,"api")," package inside ",l.createElement(t.code,null,"\\routers")," doesn't actually contain any Go code directly.\nInstead it is the parent-package of packages like ",l.createElement(t.code,null,"forgejo.org/services/api/actions/runner"),"."),"\n",l.createElement(t.p,null,"Naturally, we want as little code as possible in the upper layers.\nCode in such layers is a lot harder to reason about.\nAfter all it has access to so much stuff with so many effects and side-effects.\nThis will become important when I talk about the refactoring my feature required."),"\n",l.createElement(t.h2,{id:"forgejos-pub-sub-pattern",style:{position:"relative"}},l.createElement(t.a,{href:"#forgejos-pub-sub-pattern","aria-label":"forgejos pub sub pattern permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Forgejo's Pub-Sub Pattern"),"\n",l.createElement(t.p,null,"We've seen how Go packages may import other Go packages.\nTake a look at this situation where simple imports don't work:",l.createElement("br"),"\n",l.createElement(t.code,null,"forgejo.org/services/automerge")," imports ",l.createElement(t.code,null,"forgejo.org/services/pull")," to check if a pull request is mergeable.\nBut when there has been a pull request review, ",l.createElement(t.code,null,"forgjeo.org/services/automerge")," needs to realize that.\nWho knows there has been a pull request review?\n",l.createElement(t.code,null,"forgejo.org/services/pull")," of course.\nSo one package needs the other and the other needs the one; a cyclical dependency.\nSimply importing the respective package doesn't work because Go forbids cyclical imports.\nWhat does work is importing a third package, ",l.createElement(t.code,null,"forgejo.org/services/notify"),".\n",l.createElement(t.code,null,"forgejo.org/services/notify")," is a broker and relays messages grouped into topics to interested code.\nAn example topic is ",l.createElement(t.code,null,"PullRequestReview"),".\n",l.createElement(t.code,null,"forgejo.org/services/pull")," sends a message to that topic whenever there is a new review for a pull request.\nBecause ",l.createElement(t.code,null,"forgejo.org/services/automerge")," is interested in such messages, it creates a struct abiding by the ",l.createElement(t.code,null,"Notifier")," interface.\nThe notifier implements the ",l.createElement(t.code,null,"PullRequestReview")," function and registers itself with the broker.\nTherefore the broker doesn't have to import the ",l.createElement(t.code,null,"forgejo.org/services/automerge")," package.\nThis is called dependency injection and resolved the cyclic dependency.\nHere is some example code:"),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},'// in /services/automerge\nimport notify_service "forgejo.org/services/notify"\n\n// Define the notifier.\ntype automergeNotifier struct {\n\tnotify_service.NullNotifier\n}\n\n// Ensure that this struct fulfills the Notifier interface.\nvar _ notify_service.Notifier = &automergeNotifier{}\n\n// Declare functions for all topics the package is interested in.\nfunc (n *automergeNotifier) PullRequestReview(/* --snip-- */) {\n// --snip--\n\n// Tell the broker there\'s a new notifier to be notified.\nnotify_service.RegisterNotifier(&automergeNotifier{})\n')),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},"// in /services/pull\n\n// send a message to some topic\nnotify_service.PullRequestReview(/* --snip-- */)\n")),"\n",l.createElement(t.p,null,"Because code and publish messages and subscribe to topics this pattern is called the pub-sub pattern.\nI find this pub-sub pattern highly intuitive topics and messages are a concept we're confronted with in our everyday lives.\nAdditionally, it allows you to get a quick overview over what code is interested in what change.\nFor example, if you give this interactive visualization a brief look, you can figure out that the code related to Forgjeo packages is quite separate from everything else."),"\n",l.createElement(s,{src:"https://christopher-besch.github.io/go_observer_pattern_visualizer/viewer",fullscreen:!0}),"\n",l.createElement(t.p,null,"If you're interested in this visualization and what the commit history on the right has to do with it, take a look at my new article: ",l.createElement(t.a,{href:"/articles/forgejo_pub_sub_pattern_history"},"The History of Forgejo's Pub-Sub Pattern")),"\n",l.createElement(t.h2,{id:"my-contribution",style:{position:"relative"}},l.createElement(t.a,{href:"#my-contribution","aria-label":"my contribution permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"My Contribution"),"\n",l.createElement(t.p,null,"Forgejo features Actions, enabling continuous integrations.\nOne can configure an Action to compile or test code e.g., whenever there is a new commit or pull request.\nA failed Action Run indicates a problem with the just introduced code.\nThus, the developer must change her code in this situation.\nBut how does she notice something went amiss?\nBefore my Contribution the only option was Forgejo's web UI.\nThis is a ",l.createElement(t.em,null,"pull notification")," because the developer must open the UI and ",l.createElement(t.em,null,"pull")," the notification from the server.\nI desired ",l.createElement(t.em,null,"push notifications")," in the form of email and webhooks.\nWith email notifications the developer receives a friendly notice mail that her Action Run failed and a webhook sends a machine readable web request to some automated system.\nI wanted to develop those features.\nBut where do you even start?\nFirstly, it makes sense to add a new topic to the pub-sub pattern, ",l.createElement(t.code,null,"ActionRunNowDone"),".\n",l.createElement(t.code,null,"forgejo.org/services/mailer")," and ",l.createElement(t.code,null,"forgejo.org/services/webhook")," are responsible for sending mails and webhooks so they should listen to that new topic.\nThen we only need something to send a message to that topic whenever an Action Run completes.\n",l.createElement(t.code,null,"forgejo.org/models/actions")," provides the database abstraction for Action Runs.\nIt's ",l.createElement(t.code,null,"UpdateRunJob")," function performs all changes including those indicating a completed Action Run.\nTherefore, that function should send the message.\nHowever, there's a problem:\nWhen we think back to Forgejo's layered architecture we realize that\n",l.createElement(t.code,null,"forgejo.org/models/actions")," is not allowed to import ",l.createElement(t.code,null,"forgejo.org/services/notify"),", because it lies in a lower layer."),"\n",l.createElement(t.h3,{id:"pr-7510-refactoring",style:{position:"relative"}},l.createElement(t.a,{href:"#pr-7510-refactoring","aria-label":"pr 7510 refactoring permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"PR ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7510"},"#7510"),": Refactoring"),"\n",l.createElement(t.p,null,"This is where my first pull request comes in.\nI had to move some code from ",l.createElement(t.code,null,"forgejo.org/models/actions")," up a layer into ",l.createElement(t.code,null,"forgejo.org/services/actions"),".\nThat's where Actions-related code lives that needs to import more things.\nIn order to make my PR as easy to review (and approve) as possible, I tried to move only as much as was absolutely needed.\nOf course I had to move ",l.createElement(t.code,null,"UpdateRunJob")," but e.g., ",l.createElement(t.code,null,"CleanRepoScheduleTasks")," calls ",l.createElement(t.code,null,"UpdateRunJob"),".\nIf I had only moved ",l.createElement(t.code,null,"UpdateRunJob"),", ",l.createElement(t.code,null,"CleanRepoScheduleTasks")," would require an import of ",l.createElement(t.code,null,"forgejo.org/services/actions"),".\nBut that is again not possible because of the layered architecture.\nTherefore, I also had to move all the function transitively changing the Actions Run's status."),"\n",l.createElement(t.h3,{id:"pr-7491-actionrunnowdone-topic",style:{position:"relative"}},l.createElement(t.a,{href:"#pr-7491-actionrunnowdone-topic","aria-label":"pr 7491 actionrunnowdone topic permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"PR ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7491"},"#7491"),": ",l.createElement(t.code,null,"ActionRunNowDone")," Topic"),"\n",l.createElement(t.p,null,"Now ",l.createElement(t.code,null,"UpdateRunJob")," calls the ",l.createElement(t.code,null,"sendActionRunNowDoneNotificationIfNeeded")," function, which I just implemented.\nIt sends a message to the new ",l.createElement(t.code,null,"ActionRunNowDone")," topic whenever an Action Run is now done.\nFinally, I added a bunch of tests ensuring that in all cases the ",l.createElement(t.code,null,"ActionRunNowDone")," topic is used."),"\n",l.createElement(t.h3,{id:"pr-7509-actions-done-mail",style:{position:"relative"}},l.createElement(t.a,{href:"#pr-7509-actions-done-mail","aria-label":"pr 7509 actions done mail permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"PR ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7509"},"#7509"),": Actions Done Mail"),"\n",l.createElement(t.p,null,l.createElement(t.code,null,"forgejo.org/services/mailer"),"'s notifier received interest in the ",l.createElement(t.code,null,"ActionRunNowDone")," topic in this PR.\nI made it send out a mail whenever a Run failed or recovered (i.e., succeeded after a prior failure).\nAgain, I added a bunch of tests ensuring whenever an ",l.createElement(t.code,null,"ActionRunNowDone")," message requires it a mail is sent."),"\n",l.createElement(t.h3,{id:"7508-actions-done-webhook",style:{position:"relative"}},l.createElement(t.a,{href:"#7508-actions-done-webhook","aria-label":"7508 actions done webhook permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7508"},"#7508"),": Actions Done Webhook"),"\n",l.createElement(n,{full:!1,src:i}),"\n",l.createElement(t.p,null,"In this PR ",l.createElement(t.code,null,"forgejo.org/services/webhook")," got interested in the ",l.createElement(t.code,null,"ActionRunNowDone")," topic, too.\nIt sends out HTTP requests to the webhooks configured in the new settings.\nI had to introduce the ",l.createElement(t.code,null,"ActionRun")," struct, which allows serialising an action to be sent to the webhook.\nOf course, I added a bunch of tests ensuring whenever an ",l.createElement(t.code,null,"ActionRunNowDone")," message requires it a webhook is sent."),"\n",l.createElement(c),"\n",l.createElement(t.h3,{id:"repoactionrun-and-actionrun-structs",style:{position:"relative"}},l.createElement(t.a,{href:"#repoactionrun-and-actionrun-structs","aria-label":"repoactionrun and actionrun structs permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),l.createElement(t.code,null,"RepoActionRun")," and ",l.createElement(t.code,null,"ActionRun")," Structs"),"\n",l.createElement(t.p,null,"While I got ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7508"},"#7508")," merged, ",l.createElement(t.a,{href:"https://codeberg.org/klausfyhn"},"klausfyhn"),"'s ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7699"},"#7699")," extended Forgejo's API.\nThe new endpoints allow for retrieving Action runs programmatically and, which, of course, needed an ",l.createElement(t.code,null,"ActionRun")," struct for serialisation.\nSo his and my PR introduced the same struct at the same time and broke the main ",l.createElement(t.code,null,"forgejo")," branch, ups.\n",l.createElement(t.a,{href:"https://codeberg.org/earl-warren"},"Earl Warren")," quickly resolved the merge conflict in ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/8066"},"#8066")," by renaming ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7699"},"#7699"),"'s struct to ",l.createElement(t.code,null,"RepoActionRun"),".\nThen, because having two structs for the same purpose is bad, he removed the ",l.createElement(t.code,null,"RepoActionRun"),", leaving only ",l.createElement(t.code,null,"ActionRun")," in ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/8250"},"#8250"),".\nBoth the webhook and the API use the same struct now."),"\n",l.createElement(t.h3,{id:"other-prs",style:{position:"relative"}},l.createElement(t.a,{href:"#other-prs","aria-label":"other prs permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Other PRs"),"\n",l.createElement(n,{full:!1,src:r}),"\n",l.createElement(t.p,null,"A few more PRs accompanied this feature, which I won't get into detail:"),"\n",l.createElement(t.ul,null,"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/7697"},"#7697"),": After the Fact Cleanup"),"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/8227"},"#8227"),": (Earl Warren) Only single user receives mail"),"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo/pulls/8242"},"#8242"),": (Earl Warren) actions mail opt-in"),"\n"),"\n",l.createElement(t.p,null,"With all that work done Action notification got into the v12.0 release of Forgejo!"),"\n",l.createElement(c),"\n",l.createElement(t.h2,{id:"development-setup",style:{position:"relative"}},l.createElement(t.a,{href:"#development-setup","aria-label":"development setup permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Development Setup"),"\n",l.createElement(t.p,null,"To test the features I developed I don't just need the Forgejo executable.\nNo, I also need an action runner, a mail server and some place to send webhooks to."),"\n",l.createElement(t.h3,{id:"forgejo-itself",style:{position:"relative"}},l.createElement(t.a,{href:"#forgejo-itself","aria-label":"forgejo itself permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Forgejo itself"),"\n",l.createElement(t.p,null,"Let's start with just getting a Forgejo test instance up and running."),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"I use Debian but this setup should work on all Linux distros (and maybe macOS and BSD?)."),"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://github.com/nvm-sh/nvm?tab=readme-ov-file#install--update-script"},"Install node and npm"),"."),"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://go.dev/doc/install"},"Install go"),"."),"\n",l.createElement(t.li,null,"Install ",l.createElement(t.a,{href:"https://github.com/gotestyourself/gotestsum"},"gotestsum"),".\nThis is entirely optional.\nIf you don't install gotestsum, ignore all the ",l.createElement(t.code,null,"USE_GOTESTSUM=yes")," statements below."),"\n",l.createElement(t.li,null,"Download the ",l.createElement(t.a,{href:"https://codeberg.org/forgejo/forgejo"},"Forgejo Repo")," with ",l.createElement(t.code,null,"git clone https://codeberg.org/forgejo/forgejo ~/forgejo && cd ~/forgejo"),"."),"\n",l.createElement(t.li,null,"Build an executable with ",l.createElement(t.code,null,'STRIP="0" EXTRA_GOFLAGS=\'-gcflags="all=-N -l"\' TAGS="sqlite sqlite_unlock_notify" make build'),".\nIt took me a while to realize that ",l.createElement(t.code,null,"go build")," enables optimization by default but keeps all debug symbols present.\nWe change that with the ",l.createElement(t.code,null,"gsflags")," by neither optimizing or inlining.\nFurthermore, Forgejo's Makefile strips the debug symbols so we disable that with the ",l.createElement(t.code,null,"STRIP")," environment variable."),"\n",l.createElement(t.li,null,"Run ",l.createElement(t.code,null,"./gitea"),".\nYes, the executable is still called that."),"\n",l.createElement(t.li,null,"Open a webbrowser and navigate to ",l.createElement(t.a,{href:"http://localhost:3000"},"http://localhost:3000"),"."),"\n",l.createElement(t.li,null,"Choose SQLite, create an admin account and keep everything else default.\nYour config is in ",l.createElement(t.code,null,"~/forgejo/custom/conf/app.ini"),"."),"\n",l.createElement(t.li,null,"Create the ",l.createElement(t.code,null,"test_repo")," repository and add the file ",l.createElement(t.code,null,".forgejo/workflows/main.yml"),":","\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-yaml"},"enable-email-notifications: true\non:\n  workflow_dispatch:\n\njobs:\n  test:\n    runs-on: self-hosted\n    steps:\n      - name: Echo\n        run: |\n          echo Hello World!\n      - name: Fail\n        run: |\n          false\n")),"\n","You can make your life a little easier by cloning the repo: ",l.createElement(t.code,null,"git clone http://localhost:3000/chris_admin/test_repo.git ~forgejo_test_repo"),".\nYou'll have to follow the prompts and configure your ",l.createElement(t.code,null,"user.email")," and ",l.createElement(t.code,null,"user.name"),".\nI'm using password login, btw."),"\n"),"\n",l.createElement(t.h3,{id:"forgejo-runner",style:{position:"relative"}},l.createElement(t.a,{href:"#forgejo-runner","aria-label":"forgejo runner permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Forgejo Runner"),"\n",l.createElement(t.p,null,"To test workflow I need a runner."),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"Download the ",l.createElement(t.a,{href:"https://code.forgejo.org/forgejo/runner/releases"},"Forgejo runner binary")," into ",l.createElement(t.code,null,"~/forgejo_runner"),"."),"\n",l.createElement(t.li,null,"Register the runner with ",l.createElement(t.code,null,"./forgejo-runner-11.1.2-linux-amd64 register"),", give the instance URL ",l.createElement(t.code,null,"http://localhost:3000"),", the runner token you get from the repo settings in the web interface, choose a name like ",l.createElement(t.code,null,"test-runner")," and select the label ",l.createElement(t.code,null,"self-hosted:host"),"."),"\n",l.createElement(t.li,null,"Run ",l.createElement(t.code,null,"./forgejo-runner-11.1.2-linux-amd64 daemon")," and click the workflow trigger button in the web interface.\nYou should see your workflow run now."),"\n"),"\n",l.createElement(t.h3,{id:"mail-server",style:{position:"relative"}},l.createElement(t.a,{href:"#mail-server","aria-label":"mail server permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Mail Server"),"\n",l.createElement(t.p,null,"Okay, that works fine but we also want to test sending emails.\nI use ",l.createElement(t.a,{href:"https://github.com/maildev/maildev"},"MailDev")," to create a development email server.\nIt provides an SMTP server, which Forgejo connects to, and a webinterface for me, the developer."),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://docs.docker.com/engine/install"},"Install Docker"),"."),"\n",l.createElement(t.li,null,"Run ",l.createElement(t.code,null,"docker run --network host -p 1080:1080 -p 1025:1025 maildev/maildev"),"."),"\n",l.createElement(t.li,null,"Open ",l.createElement(t.a,{href:"http://localhost:1080"},"http://localhost:1080")," in a webbrowser."),"\n",l.createElement(t.li,null,"Shutdown Forgejo and edit it's config (in ",l.createElement(t.code,null,"~/forgejo/custom/conf/app.ini"),").","\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-ini"},"[mailer]\nENABLED = true\nPROTOCOL = smtp\nSMTP_ADDR = localhost\nSMTP_PORT = 1025\nFROM = forgejo@localhost\n\n# make sure this is true\n[service]\nENABLE_NOTIFY_MAIL = true\n")),"\n"),"\n",l.createElement(t.li,null,"Now, when the workflow fails you should get a mail in the MailDev web interface."),"\n"),"\n",l.createElement(t.h3,{id:"webhook",style:{position:"relative"}},l.createElement(t.a,{href:"#webhook","aria-label":"webhook permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Webhook"),"\n",l.createElement(t.p,null,"Furthermore, we want to test webhooks."),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,"I'm using ",l.createElement(t.a,{href:"https://stackoverflow.com/a/46787467"},"this node script")," as a test webhook:\n",l.createElement(t.code,null,"webhook_tester.js"),":","\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-js"},'#!/usr/bin/env node\n\nconst http = require("http");\n\nconst hostname = "0.0.0.0";\nconst port = 8001;\n\nconst server = http.createServer((req, res) => {\n  console.log(`\\n${req.method} ${req.url}`);\n  console.log(req.headers);\n\n  req.on("data", function(chunk) {\n    console.log("BODY: " + chunk);\n  });\n\n  res.statusCode = 200;\n  res.setHeader("Content-Type", "text/plain");\n  res.end("Hello World\\n");\n});\n\nserver.listen(port, hostname, () => {\n  console.log(`Server running at http://localhost:${port}/`);\n});\n')),"\n"),"\n",l.createElement(t.li,null,"Run ",l.createElement(t.code,null,"./webhook_tester.js"),"."),"\n",l.createElement(t.li,null,"Shutdown Forgejo and edit it's config (in ",l.createElement(t.code,null,"~/forgejo/custom/conf/app.ini"),").\nFor Forgejo to accept ",l.createElement(t.code,null,"http://localhost:8001")," as a webhook target you need to add this:","\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-ini"},"[webhook]\nALLOWED_HOST_LIST = *\nSKIP_TLS_VERIFY = true\n")),"\n"),"\n",l.createElement(t.li,null,"Create a new webhook in the Repo Settings and use the target URL ",l.createElement(t.code,null,"http://localhost:8001"),".\nEnable either ",l.createElement(t.em,null,"All events")," or ",l.createElement(t.em,null,"Custom events"),", selecting the ",l.createElement(t.em,null,"Action Run events"),"."),"\n",l.createElement(t.li,null,"Start the workflow, let it fail and watch the sent webhook in the node terminal."),"\n"),"\n",l.createElement(t.p,null,"Now we have everything to play with the features I implemented."),"\n",l.createElement(t.h2,{id:"running-tests",style:{position:"relative"}},l.createElement(t.a,{href:"#running-tests","aria-label":"running tests permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Running Tests"),"\n",l.createElement(t.p,null,"Forejeo has different types of tests.\nI was concerned with these types."),"\n",l.createElement(t.ul,null,"\n",l.createElement(t.li,null,"Run all unit tests with ",l.createElement(t.code,null,"TAGS='sqlite sqlite_unlock_notify' USE_GOTESTSUM=yes make test"),"."),"\n",l.createElement(t.li,null,"Run all integration tests with ",l.createElement(t.code,null,"TAGS='sqlite sqlite_unlock_notify' USE_GOTESTSUM=yes make test-sqlite"),"."),"\n"),"\n",l.createElement(t.p,null,"Say you only want to run this unit test in ",l.createElement(t.code,null,"~/forgejo/models/actions/run_test.go"),":"),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},"func TestGetRunBefore(t *testing.T) {\n  // --snip--\n}\n")),"\n",l.createElement(t.p,null,"Then you can execute ",l.createElement(t.code,null,"USE_GOTESTSUM=yes TAGS='sqlite sqlite_unlock_notify' GO_TEST_PACKAGES='forgejo.org/models/actions' make 'test#TestGetRunBefore'"),".\nBut what if, instead, you are concerned with this integration test in ",l.createElement(t.code,null,"~/forgejo/tests/integration/actions_notifications_test.go"),":"),"\n",l.createElement(t.pre,null,l.createElement(t.code,{className:"language-go"},"func TestActionNotifications(t *testing.T) {\n  // --snip--\n}\n")),"\n",l.createElement(t.p,null,"Then you can run ",l.createElement(t.code,null,"USE_GOTESTSUM=yes TAGS='sqlite sqlite_unlock_notify' make 'test-sqlite#TestActionNotifications'"),".\nBtw, there are other types of tests, namely frontend tests and the End-to-End tests in a ",l.createElement(t.a,{href:"https://code.forgejo.org/forgejo/end-to-end"},"special repo"),".\nI didn't work with these yet so I direct you to the ",l.createElement(t.a,{href:"https://forgejo.org/docs/latest/contributor/testing"},"testing docs"),"."),"\n",l.createElement(t.h2,{id:"debugging",style:{position:"relative"}},l.createElement(t.a,{href:"#debugging","aria-label":"debugging permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Debugging"),"\n",l.createElement(t.p,null,"I like the terminal and am used to GDB.\nTherefore, I'm using the terminal debugger ",l.createElement(t.a,{href:"https://github.com/go-delve/delve"},"Delve"),".\nLet's set things up for that:"),"\n",l.createElement(t.ol,null,"\n",l.createElement(t.li,null,l.createElement(t.a,{href:"https://github.com/go-delve/delve/tree/master/Documentation/installation"},"Install Delve"),"."),"\n",l.createElement(t.li,null,"Build Forgejo as described ",l.createElement(t.a,{href:"#development-setup"},"above"),"."),"\n",l.createElement(t.li,null,"Run ",l.createElement(t.code,null,"dlv exec ./gitea"),"."),"\n",l.createElement(t.li,null,"Now we can use the Delve console while Forgejo runs, letting you interact with the web interface.\nFor example you can do ",l.createElement(t.code,null,"break forgejo.org/services/mailer.(*mailNotifier).ActionRunNowDone"),", ",l.createElement(t.code,null,"break forgejo.org/services/notify.ActionRunNowDone")," and ",l.createElement(t.code,null,"continue"),".\nHit ",l.createElement(t.code,null,"Ctrl+C")," to enter a Delve command and type ",l.createElement(t.code,null,"quit")," to exit."),"\n"),"\n",l.createElement(t.p,null,"Say you want to debug the above unit test.\nThen you can use Delve with this command: ",l.createElement(t.code,null,"dlv test --build-flags \"-tags='sqlite,sqlite_unlock_notify' -run TestGetRunBefore\" forgejo.org/models/actions"),".\nIf, instead,  you want to debug the above integration test, run ",l.createElement(t.code,null,'make integrations.sqlite.test generate-ini-sqlite && GITEA_ROOT="$(pwd)" GITEA_CONF=tests/sqlite.ini dlv exec ./integrations.sqlite.test -- -test.run TestActionNotifications'),".\nHere you can break on some line number, too: ",l.createElement(t.code,null,"break ./tests/integration/actions_notifications_test.go:22"),"\nTo debug something else, take a look at Forgejo's Makefile and find what command make the things you want to debug run.\nJust replace ",l.createElement(t.code,null,"go test")," with ",l.createElement(t.code,null,"delve")," and place all ",l.createElement(t.code,null,"go test")," arguments in the ",l.createElement(t.code,null,"--build_flags")," Delve argument.\nYou can break on line numbers, too: ",l.createElement(t.code,null,"break ./models/actions/run_test.go:19")),"\n",l.createElement(t.h2,{id:"conclusion-and-lessons-learned",style:{position:"relative"}},l.createElement(t.a,{href:"#conclusion-and-lessons-learned","aria-label":"conclusion and lessons learned permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Conclusion and Lessons Learned"),"\n",l.createElement(t.p,null,"We've seen the structure of any Go project, Forgejos layered architecture and pub-sub pattern, how I contributed and with what development setup.\nNow I understand better just how valuable a deep understanding of the project you're working on is.\nThis really allows you to make the least invasive change to the code and still implement your feature.\nAnd a smaller change is much easier to understand, review and approve.\nWe all benefit from that.\nBreaking things up into multiple PRs goes along nicely with that, too.\nEven though I didn't go in-depth in this article, I spent a lot of time writing tests.\nThose tests are really important and not just a side-gig you slap onto the \"real\" code.\nThey enable the maintainers to check things still work as they should when new code comes along and you might have gone somewhere else."),"\n",l.createElement(t.p,null,"And lastly, of course, the Forgejo maintainers are absolutely amazing.\nEspecially ",l.createElement(t.a,{href:"https://codeberg.org/earl-warren"},"Earl Warren")," did a great job helping me on my journey."),"\n",l.createElement(t.h2,{id:"ps",style:{position:"relative"}},l.createElement(t.a,{href:"#ps","aria-label":"ps permalink",className:"anchor before"},l.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"P.S."),"\n",l.createElement(t.p,null,"I created the talk ",l.createElement(t.a,{href:"https://present.chris-besch.com/2025_11_21_ibm_forgejo/"},"Contributing to Forgejo")," around this article."))}var c=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,o.R)(),e.components);return t?l.createElement(t,e,l.createElement(s,e)):s(e)};function u(e,t){throw new Error("Expected "+(t?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}var h=n(5365),d=n(2224),m=n(9121),g=n(4241),p=n(4810),f=n(1244),v=n(5071),E=n(9105),b=n(6897),w=n(7629),y=n(8029),k=n(1042),j=n(5526),S=n(5969);const _={AutoPlayVideo:v.A,HalfImage:E.A,Spacer:b.A,Quote:w.A,Iframe:y.A,CompareView:f.A,pre:e=>{let{children:t}=e;return l.createElement("div",{className:"code-container"}," ",l.createElement("pre",null,t))},code:e=>{let{children:t,className:n}=e;return n?l.createElement(j.A,{className:n},t):l.createElement("code",{className:"language-text"},t)},a:S.A},T=e=>{var t,n,a,r,i,s,c,u,f,v,E,b,w,y;let{data:k,children:j}=e;const S=null===(t=k.mdx)||void 0===t||null===(n=t.frontmatter)||void 0===n?void 0:n.version,T=null===(a=k.mdx)||void 0===a||null===(r=a.frontmatter)||void 0===r?void 0:r.title,I=/^0\./.test(S)?`Draft v${S}`:void 0,H=null===(i=k.mdx)||void 0===i||null===(s=i.frontmatter)||void 0===s?void 0:s.date,R=null!=(null===(c=k.mdx)||void 0===c||null===(u=c.frontmatter)||void 0===u?void 0:u.title_banner),A={"--banner-image-horizontal-position":null===(f=k.mdx)||void 0===f||null===(v=f.frontmatter)||void 0===v?void 0:v.title_banner_horizontal_position,"--banner-image-vertical-position":null===(E=k.mdx)||void 0===E||null===(b=E.frontmatter)||void 0===b?void 0:b.title_banner_vertical_position};return l.createElement(h.A,{heading:T,sub_heading:I,banner_image:R?null===(w=k.mdx)||void 0===w||null===(y=w.frontmatter)||void 0===y?void 0:y.title_banner:void 0,banner_image_style:A,small_banner:!0,banner_content:l.createElement("div",{className:`${d.yu} ${R?d.Lx:void 0}`},l.createElement("span",{className:d.cy},"Written by Christopher Besch, published on "),H)},l.createElement("div",{className:m.xo},l.createElement(o.x,{components:_},j)),l.createElement(p.N_,{className:`${g.om} ${g.nf}`,to:"/articles"},"More Articles"))};function I(e){return l.createElement(T,e,l.createElement(c,e))}const H=e=>{var t,n,o,a,r,i;let{data:s}=e;const c=null===(t=s.mdx)||void 0===t||null===(n=t.frontmatter)||void 0===n?void 0:n.title,u=null===(o=s.mdx)||void 0===o||null===(a=o.frontmatter)||void 0===a?void 0:a.description,h=null===(r=s.mdx)||void 0===r||null===(i=r.frontmatter)||void 0===i?void 0:i.banner,d=h&&"undefined"!=h?h:void 0;return l.createElement(k.A,{heading:c,description:u,banner:d})}}}]);
//# sourceMappingURL=component---src-templates-article-tsx-content-file-path-src-articles-17-forgejo-actions-notification-forgejo-actions-notification-md-6c66991449a7acdac607.js.map