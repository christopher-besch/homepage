"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[889],{3440:function(e,t,n){n.r(t),n.d(t,{Head:function(){return I},default:function(){return _}});var o=n(8453),a=n(6540);function r(e){const t=Object.assign({p:"p",code:"code",a:"a",pre:"pre",h2:"h2",span:"span",strong:"strong"},(0,o.R)(),e.components);return a.createElement(a.Fragment,null,a.createElement(t.p,null,"Heads up:\nYou should get this article's gist even without any technical knowledge.\nJust replace all technical concepts with ",a.createElement(t.code,null,"Black Box blabla")," and you'll be fine."),"\n",a.createElement(t.p,null,"The other day I set up ",a.createElement(t.a,{href:"https://docs.renovatebot.com"},"Renovate"),", a bot that scans my code for outdated dependencies.\nThere is a ",a.createElement(t.a,{href:"https://hub.docker.com/r/renovate/renovate"},"Renovate Docker image")," and my ",a.createElement(t.a,{href:"https://codeberg.org/christopher-besch/docker_setups"},"personal server")," runs everything else in Docker containers, too.\nSo I chose that deployment and was only looking for a way to initiate scans at regular intervals.\nYou initiate a scan by executing the Renovate binary inside the container."),"\n",a.createElement(t.p,null,"Of course this is not a new problem.\nThe typical approach on a deployment without Docker uses cron.\ncron is a simple tool that takes a command combined with a time/date pattern, which I call cron time.\nIt then runs the command at the provide cron time (e.g. hourly, daily, ...).\nDocker, however, doesn't provide something like cron.\nTo fill this gap I created ",a.createElement(t.a,{href:"https://github.com/christopher-besch/docker_cron"},"docker_cron"),", a separate Docker container that searches for other containers with the ",a.createElement(t.code,null,"CRON_TIME")," environment variable set.\nLet's call those service containers.\ndocker_cron sends a Unix HUP signal to the service container whenever the provided cron time is hit.\nA tiny script inside the service container awaits that signal and then runs the container's main executable."),"\n",a.createElement(t.p,null,"This is how you configure the service container's ",a.createElement(t.code,null,"docker-compose.yml"),":"),"\n",a.createElement(t.pre,null,a.createElement(t.code,{className:"language-yaml"},'services:\n  Renovate:\n    image: renovate/renovate\n    volumes:\n      - "entrypoint.sh:/entrypoint.sh"\n    environment:\n      - GITHUB_COM_TOKEN=some_token\n      - RENOVATE_TOKEN=some_token\n      - "CRON_TIME=13 0 * * *"\n    entrypoint: /entrypoint.sh\n\n  DockerCron:\n    image: chrisbesch/docker_cron\n    volumes:\n      - "/var/run/docker.sock:/var/run/docker.sock:rw"\n')),"\n",a.createElement(t.p,null,"You only need one docker_cron container for the entire host.\nThen all you have to do is place this ",a.createElement(t.code,null,"entrypoint.sh")," file next to the ",a.createElement(t.code,null,"docker-compose.yml"),"."),"\n",a.createElement(t.pre,null,a.createElement(t.code,{className:"language-bash"},"#!/bin/bash\n\n# Launch renovate when we receive a HUP signal\n# from the docker_cron container.\ntrap 'renovate' HUP\n# Sleep and wait for the HUP signal.\nwhile :; do\n    sleep 10 & wait ${!}\ndone\n")),"\n",a.createElement(t.p,null,"What's good about docker_cron is how small it is.\nYou can easily review everything docker_cron is in a few minutes:\nThere's a total of 45 lines of ",a.createElement(t.a,{href:"https://github.com/christopher-besch/docker_cron/blob/main/Dockerfile"},"Dockerfile"),", ",a.createElement(t.a,{href:"github.com/christopher-besch/docker_cron/blob/main/init.sh"},"bash script")," and ",a.createElement(t.a,{href:"https://github.com/christopher-besch/docker_cron/blob/main/crontab.tmpl"},"crontab template"),".\nIts only dependencies are docker-gen and, well of course, cron.\nFYI, the nginx team develops docker-gen for their official Docker image.\nSo it's not some obscure thing no one uses or maintains."),"\n",a.createElement(t.h2,{id:"so-what-about-that-bitter-feeling-in-the-title",style:{position:"relative"}},a.createElement(t.a,{href:"#so-what-about-that-bitter-feeling-in-the-title","aria-label":"so what about that bitter feeling in the title permalink",className:"anchor before"},a.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),'So What About that "Bitter Feeling" in the Title?'),"\n",a.createElement(t.p,null,"Unfortunately there is no way of creating something like docker_cron without giving it access to the Docker daemon socket.\nWith this access the container has full root access to the host machine.\nThat, of course, is not great.\nI really dislike this, actually.\nI dislike it so much that whenever I look at my server's deployment, with it's dozens of containers relying on docker_cron, I have this bitter feeling. ",a.createElement("br"),"\nYou know, I recognise this feeling from whenever I create, whenever I design.\nIt highlights things I should be cautious of using.\nIt is on high alert when some dependency uses external servers;\nexternal servers that could go dark at any moment.\nOr when I consider something hacky that will fall apart too soon or just waits to be exploited.\nThis feeling fights for the simplest, cleanest solution possible and no less."),"\n",a.createElement(t.p,null,"Now, this time I indulged it and again looked for a simpler solution:\nI tried integrating cron in the container itself.\nSo instead of an entrypoint script I'm using cron inside the Renovate container directly.\nThat sounds a lot simpler than the docker_cron solution, right? ",a.createElement("br"),"\nCue the first problem:\ncron isn't already installed inside the Renovate container.\nWhat do you do?\nYou add the entrypoint script back and make it install cron from the Debian repositories.\nLet's hope those haven't gone dark when you want to restart your container.\nOh, and that of course doesn't work for containers that shouldn't have any access to the internet.\nThat's actually a bunch of my containers."),"\n",a.createElement(t.p,null,"But there's another problem: stdout.\nFor debugging purposes I want access to Renovate's log output.\nDocker already provides a way to store a process' log output.\nFor this the Docker daemon attaches to the stdout of the container's main process.\nIn our case the main process is cron and not Renovate because cron lauches it's commands in the background.\nTherefore, the Renovate's log output is lost.\nWhat you have to do is redirect the bot's stdout to cron's stdout.\nThat's quite a complicated thing to do and there is a lot to trip over.\nAnd you know what?\nThat feels like a hack â€” a hack making that bitter feeling flare up again.\nSo this alternative solution felt simpler at first but turned out causing a bunch of other problems requiring workarounds and trade-offs."),"\n",a.createElement(t.p,null,"Which solution do you want to use?\nThough you could argue both ways, personally I prefer docker_cron and will keep using it.\nI find the security implications acceptable considering how easy to review docker_cron is. ",a.createElement("br"),"\nUnfortunately, this Renovate-endeavour of mine didn't rid myself of that bitter feeling.\nAfter all I didn't actually improve docker_cron, I only showed that the alternative is worse.\nIn a perfect world Docker itself would offer some form of cron support.\nMy docker_cron solution, right now, is the next best thing and all it's problems originate from a carefully weighted trade-off.\nNow it's on me to accept that and keep going."),"\n",a.createElement(t.h2,{id:"what-remains",style:{position:"relative"}},a.createElement(t.a,{href:"#what-remains","aria-label":"what remains permalink",className:"anchor before"},a.createElement(t.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"What Remains"),"\n",a.createElement(t.p,null,"What remains at the end of this more personal article?\nAn article I mostly wrote for myself, that is.\nLet's put it this way: ",a.createElement("br"),"\nCriteria like code smells, best practices and the like can only get you so far.\nAt some level of problem complexity you need to compromise.\nThen you trade one best practice against some other.\nThat's normal.\nWhat's important is ",a.createElement(t.strong,null,"when")," you have these considerations: ",a.createElement("br"),"\nWhen you design the architecture, this is fine.\nWhen you review your deployment, this is fine.\nWhen you implement, deploy and administrate, however, you just have to trust your previous considerations."))}var i=function(e){void 0===e&&(e={});const{wrapper:t}=Object.assign({},(0,o.R)(),e.components);return t?a.createElement(t,e,a.createElement(r,e)):r(e)},s=n(5365),l=n(2224),c=n(9121),h=n(4241),d=n(4810),m=n(1244),u=n(5071),p=n(9105),v=n(6897),f=n(7629),g=n(8029),b=n(1042),y=n(5526),k=n(5969);const w={AutoPlayVideo:u.A,HalfImage:p.A,Spacer:v.A,Quote:f.A,Iframe:g.A,CompareView:m.A,pre:e=>{let{children:t}=e;return a.createElement("div",{className:"code-container"}," ",a.createElement("pre",null,t))},code:e=>{let{children:t,className:n}=e;return n?a.createElement(y.A,{className:n},t):a.createElement("code",{className:"language-text"},t)},a:k.A},E=e=>{var t,n,r,i,m,u,p,v,f,g,b,y,k,E;let{data:_,children:I}=e;const x=null===(t=_.mdx)||void 0===t||null===(n=t.frontmatter)||void 0===n?void 0:n.version,T=null===(r=_.mdx)||void 0===r||null===(i=r.frontmatter)||void 0===i?void 0:i.title,N=/^0\./.test(x)?`Draft v${x}`:void 0,A=null===(m=_.mdx)||void 0===m||null===(u=m.frontmatter)||void 0===u?void 0:u.date,S=null!=(null===(p=_.mdx)||void 0===p||null===(v=p.frontmatter)||void 0===v?void 0:v.title_banner),H={"--banner-image-horizontal-position":null===(f=_.mdx)||void 0===f||null===(g=f.frontmatter)||void 0===g?void 0:g.title_banner_horizontal_position,"--banner-image-vertical-position":null===(b=_.mdx)||void 0===b||null===(y=b.frontmatter)||void 0===y?void 0:y.title_banner_vertical_position};return a.createElement(s.A,{heading:T,sub_heading:N,banner_image:S?null===(k=_.mdx)||void 0===k||null===(E=k.frontmatter)||void 0===E?void 0:E.title_banner:void 0,banner_image_style:H,small_banner:!0,banner_content:a.createElement("div",{className:`${l.yu} ${S?l.Lx:void 0}`},a.createElement("span",{className:l.cy},"Written by Christopher Besch, published on "),A)},a.createElement("div",{className:c.xo},a.createElement(o.x,{components:w},I)),a.createElement(d.N_,{className:`${h.om} ${h.nf}`,to:"/articles"},"More Articles"))};function _(e){return a.createElement(E,e,a.createElement(i,e))}const I=e=>{var t,n,o,r,i,s;let{data:l}=e;const c=null===(t=l.mdx)||void 0===t||null===(n=t.frontmatter)||void 0===n?void 0:n.title,h=null===(o=l.mdx)||void 0===o||null===(r=o.frontmatter)||void 0===r?void 0:r.description,d=null===(i=l.mdx)||void 0===i||null===(s=i.frontmatter)||void 0===s?void 0:s.banner,m=d&&"undefined"!=d?d:void 0;return a.createElement(b.A,{heading:c,description:h,banner:m})}}}]);
//# sourceMappingURL=component---src-templates-article-tsx-content-file-path-src-articles-15-docker-cron-docker-cron-md-1a1e9b85d13e5b365cee.js.map