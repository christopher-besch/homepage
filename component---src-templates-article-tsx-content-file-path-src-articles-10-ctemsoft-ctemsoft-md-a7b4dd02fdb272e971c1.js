"use strict";(self.webpackChunkhomepage=self.webpackChunkhomepage||[]).push([[226],{5574:function(e,n,t){t.r(n),t.d(n,{Head:function(){return A},default:function(){return P}});var o=t(8453),a=t(6540),r=t.p+"static/lens_cropped-0e6641e7c0bbac8099236b6a288535bb.mp4",l=t.p+"static/lens_3_5_cropped-4c789328e4df2b6490134a53d0321fa4.png";function i(e){const n=Object.assign({p:"p",a:"a",em:"em",pre:"pre",code:"code",ol:"ol",li:"li",h1:"h1",span:"span"},(0,o.R)(),e.components),{HalfImage:t,AutoPlayVideo:i}=n;return i||s("AutoPlayVideo",!0),t||s("HalfImage",!0),a.createElement(a.Fragment,null,a.createElement(t,{src:l}),"\n",a.createElement(n.p,null,'The other day a friend came by: "Do you know some Fortran90?"\nShe was reading "Introduction to Conventional Transmission Electron Microscopy" by Prof. Marc De Graef and wanted to reproduce Fig.3.5 on the right (or above on mobile).\nThat figure is rendered by ',a.createElement(n.a,{href:"https://github.com/christopher-besch/ctemsoft/blob/main/src/lens.f90"},"lens.f90"),".\nThing is, I don't have any experience with Fortran or electron microscopy for that matter.\nThe code is two decades old and the documentation slim."),"\n",a.createElement(n.p,null,"So what do you do?\nYou spin up a new Docker ",a.createElement(n.em,null,"container")," and start hacking.\nNaturally, you like Debian so go with that and download the ",a.createElement(n.a,{href:"https://ctem.web.cmu.edu"},"original code")," into the current working directory:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-bash"},"docker run --name ctemsoft -ti -v .:/code debian\n")),"\n",a.createElement(n.p,null,"This creates a new Docker ",a.createElement(n.em,null,"container")," off of the Debian ",a.createElement(n.em,null,"image")," and jumps you into a bash shell inside that ",a.createElement(n.em,null,"container"),".\nOnce you've figured out what commands make that Fortran code compile you can write them to ",a.createElement("del",null,"your diary")," a ",a.createElement(n.em,null,"Dockerfile"),".\nA ",a.createElement(n.em,null,"Dockerfile")," specifies how an ",a.createElement(n.em,null,"image")," is to be built allowing someone else to pick up your work where you left it off."),"\n",a.createElement(n.p,null,"Docker, if you don't already know, is great for these sorts of things.\nWhen you need a reproducible environment a virtual machine is too big a gun most of the time.\nDocker is a lot more efficient and offers more rapid turnaround times.\nAnd still, when \"it works on my machine\" using Docker, it'll work on yours too, using Docker."),"\n",a.createElement(n.p,null,"Unfortunately, this amazing tool doesn't save you from compilation errors and figuring out what dependencies you need and how to get them.\nSome ",a.createElement(n.a,{href:"https://stackoverflow.com/questions/19916119/how-do-i-find-where-a-symbol-is-defined-among-static-libraries"},"stackoverflow")," might help:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-bash"},"find / -name \\*.a -exec bash -c \"nm --defined-only {} 2>/dev/null | grep 'cgetrf_' && echo {}\" \\;\n")),"\n",a.createElement(n.p,null,"After patching the code a couple of times you get it to compile.\nFor the runtime errors you mail Prof. De Graef and are eternally grateful for his kind support.\nSeriously, do get in touch with people!\nThe patched code is on ",a.createElement(n.a,{href:"https://github.com/christopher-besch/ctemsoft"},"github.com/christopher-besch/ctemsoft"),"."),"\n",a.createElement(n.p,null,"In the end you'll have this ",a.createElement(n.em,null,"Dockerfile"),", split into two stages:"),"\n",a.createElement(n.ol,null,"\n",a.createElement(n.li,null,"The compilation stage:\nHere you need the compiler and some build dependencies.\nAll you do is copy the source code over into the ",a.createElement(n.em,null,"container")," and run ",a.createElement(n.code,null,"make all")," to compile.\nThe final binary will be in ",a.createElement(n.code,null,"/code/exe/lens"),"."),"\n",a.createElement(n.li,null,"You need that binary in the second container so you copy it over and install some runtime dependencies.\nThis includes Python which we'll get to just below."),"\n"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-dockerfile"},'# compilation stage\nFROM debian AS builder\n\nRUN apt-get update && \\\n    apt-get -y install \\\n    make \\\n    gfortran \\\n    liblapack3 \\\n    libblas3 \\\n    liblapack-dev \\\n    libblas-dev\n\nRUN mkdir -p /code/exe\nCOPY ./src/ /code/src\n\nWORKDIR /code/src\nRUN make all\n\n# Python runtime stage\nFROM debian\n\nRUN apt-get update && \\\n    apt-get -y install \\\n    libgfortran5 \\\n    python3 \\\n    python3-numpy \\\n    ghostscript \\\n    ffmpeg\n\nCOPY --from=builder /code/exe/lens \\\n    /usr/bin/lens\nCOPY ./python_src/ /python_src\nWORKDIR /python_src\nENTRYPOINT ["/bin/python3", "/python_src/main.py"]\n')),"\n",a.createElement(n.h1,{id:"lets-make-it-twirl",style:{position:"relative"}},a.createElement(n.a,{href:"#lets-make-it-twirl","aria-label":"lets make it twirl permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Let's make it twirl!"),"\n",a.createElement(i,{src:r}),"\n",a.createElement(n.p,null,"lens.f90 takes in a bunch of configuration parameters: the magnetic field strength your electron microscope boasts and the number of sampling points for example.\nLet's interpret these parameters as a vector in the six-dimensional (or nine-dimensional if you have two fields) configuration space.\nNow you can interpolate from one configuration to another:\nJust take the vector representation of the first and last configuration and linearly interpolate.\nYou can choose how many intermediate frames you want and run lens.f90 for each of them.\nThis makes a video!"),"\n",a.createElement(n.p,null,"Writing a ",a.createElement(n.a,{href:"https://github.com/christopher-besch/ctemsoft/blob/main/python_src/main.py"},"Python script")," is probably a great idea.\n",a.createElement(n.a,{href:"https://docs.python.org/3/library/subprocess.html"},a.createElement(n.code,null,"subprocess.Popen"))," is pretty neat for starting lens.f90 as it reads the configuration from stdin."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-py"},'proc = subprocess.Popen(\n    "lens",\n    stdin=subprocess.PIPE,\n)\nproc.communicate(input=str.encode(input_str))\n')),"\n",a.createElement(n.p,null,"You can even start multiple renderings at the same time and properly parallelize this baby â€” if you've already burned four hours on this maybe save two minutes twiddling your thumbs?\nlens.f90 creates a bunch of Postscript files as a result."),"\n",a.createElement(n.p,null,"With Ghostscript you convert these Postscript files to PNGs."),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-py"},'subprocess.Popen(\n    [\n        "gs",\n        "-dSAFER",\n        "-dEPSCrop",\n        f"-r150",\n        "-sDEVICE=pngalpha",\n        "-o",\n        input.output_png_file,\n        input.output_ps_file,\n    ],\n)\n')),"\n",a.createElement(n.p,null,"And now you use ffmpeg to convert the PNGs to an MP4.\nGetting ffmpeg to spit out MP4s that can be played by anything other than VLC always takes some wiggling around.\nThis is what you come up with:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-py"},'subprocess.Popen(\n    [\n        "ffmpeg",\n        "-framerate",\n        f"30",\n        "-i",\n        f"./out/%03d.png",\n        "-vcodec",\n        "libx264",\n        "-f",\n        "mp4",\n        "-vb",\n        "1024k",\n        "-preset",\n        "slow",\n        "-pix_fmt",\n        "yuv420p",\n        "./out/lens.mp4",\n    ],\n)\n')),"\n",a.createElement(n.p,null,"If you'd been especially fancy you could've used more than two configuration vectors and a spline interpolation instead of the lerp.\nBut you already consumed all your fancyness on some over-engineered application-design with way too many structs, so you don't."),"\n",a.createElement(n.h1,{id:"conclusion",style:{position:"relative"}},a.createElement(n.a,{href:"#conclusion","aria-label":"conclusion permalink",className:"anchor before"},a.createElement(n.span,{dangerouslySetInnerHTML:{__html:'<svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg>'}})),"Conclusion"),"\n",a.createElement(n.p,null,"With the (patched) Fortran code, the ",a.createElement(n.em,null,"Dockerfile")," and the Python script everyone can reproduce the compilation:\nCheck out the ",a.createElement(n.a,{href:"https://github.com/christopher-besch/ctemsoft"},"Git Repo")," and run Docker:"),"\n",a.createElement(n.pre,null,a.createElement(n.code,{className:"language-bash"},"git clone https://github.com/christopher-besch/ctemsoft\ncd ctemsoft\n# [edit python_src/main.py to your liking]\ndocker build -t chrisbesch/ctemsoft .\ndocker run -v ./out:/python_src/out chrisbesch/ctemsoft\nvlc out/lens.mp4\n")),"\n",a.createElement(n.p,null,"And now you have made an animated video out of decades old code in a language you don't know in a way people will be able to understand for decades to come."),"\n",a.createElement(n.p,null,"So when you're creating something of your own consider creating a ",a.createElement(n.em,null,"Dockerfile")," for that, too."),"\n","\n")}var c=function(e){void 0===e&&(e={});const{wrapper:n}=Object.assign({},(0,o.R)(),e.components);return n?a.createElement(n,e,a.createElement(i,e)):i(e)};function s(e,n){throw new Error("Expected "+(n?"component":"object")+" `"+e+"` to be defined: you likely forgot to import, pass, or provide it.")}var m=t(5365),u=t(2224),d=t(9121),h=t(4241),p=t(4810),f=t(1244),g=t(5071),y=t(9105),b=t(6897),v=t(7629),E=t(8029),w=t(1042),k=t(5526),_=t(5969);const N={AutoPlayVideo:g.A,HalfImage:y.A,Spacer:b.A,Quote:v.A,Iframe:E.A,CompareView:f.A,pre:e=>{let{children:n}=e;return a.createElement("div",{className:"code-container"}," ",a.createElement("pre",null,n))},code:e=>{let{children:n,className:t}=e;return t?a.createElement(k.A,{className:t},n):a.createElement("code",{className:"language-text"},n)},a:_.A},x=e=>{var n,t,r,l,i,c,s,f,g,y,b,v,E,w;let{data:k,children:_}=e;const x=null===(n=k.mdx)||void 0===n||null===(t=n.frontmatter)||void 0===t?void 0:t.version,P=null===(r=k.mdx)||void 0===r||null===(l=r.frontmatter)||void 0===l?void 0:l.title,A=/^0\./.test(x)?`Draft v${x}`:void 0,D=null===(i=k.mdx)||void 0===i||null===(c=i.frontmatter)||void 0===c?void 0:c.date,S=null!=(null===(s=k.mdx)||void 0===s||null===(f=s.frontmatter)||void 0===f?void 0:f.title_banner),C={"--banner-image-horizontal-position":null===(g=k.mdx)||void 0===g||null===(y=g.frontmatter)||void 0===y?void 0:y.title_banner_horizontal_position,"--banner-image-vertical-position":null===(b=k.mdx)||void 0===b||null===(v=b.frontmatter)||void 0===v?void 0:v.title_banner_vertical_position};return a.createElement(m.A,{heading:P,sub_heading:A,banner_image:S?null===(E=k.mdx)||void 0===E||null===(w=E.frontmatter)||void 0===w?void 0:w.title_banner:void 0,banner_image_style:C,small_banner:!0,banner_content:a.createElement("div",{className:`${u.yu} ${S?u.Lx:void 0}`},a.createElement("span",{className:u.cy},"Written by Christopher Besch, published on "),D)},a.createElement("div",{className:d.xo},a.createElement(o.x,{components:N},_)),a.createElement(p.N_,{className:`${h.om} ${h.nf}`,to:"/articles"},"More Articles"))};function P(e){return a.createElement(x,e,a.createElement(c,e))}const A=e=>{var n,t,o,r,l,i;let{data:c}=e;const s=null===(n=c.mdx)||void 0===n||null===(t=n.frontmatter)||void 0===t?void 0:t.title,m=null===(o=c.mdx)||void 0===o||null===(r=o.frontmatter)||void 0===r?void 0:r.description,u=null===(l=c.mdx)||void 0===l||null===(i=l.frontmatter)||void 0===i?void 0:i.banner,d=u&&"undefined"!=u?u:void 0;return a.createElement(w.A,{heading:s,description:m,banner:d})}}}]);
//# sourceMappingURL=component---src-templates-article-tsx-content-file-path-src-articles-10-ctemsoft-ctemsoft-md-a7b4dd02fdb272e971c1.js.map