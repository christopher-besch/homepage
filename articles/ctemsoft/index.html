<!DOCTYPE html><html><head><meta charSet="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/><title>Docker: Breathing Life into Decades old Fortran</title><meta name="description" content=" Bringing decades old Fortran code to life with Docker and animating it with Python.
Now you get to see Fig.3.5. from &quot;Introduction to Conventional Transmission Electron Microscopy&quot; by Prof. Marc De Graef at 30 frames a second. "/><link rel="stylesheet" type="text/css" href="/styles/always.css"/><link rel="stylesheet" type="text/css" href="/styles/article.css"/></head><body><div class="layout_navbar"><a class="layout_navbar_left" href="/"><h1>Christopher Besch</h1><h2>Developer•Writer•Photographer</h2></a><div class="layout_navbar_right"><input id="layout_navbar_toggle" type="checkbox"/><label for="layout_navbar_toggle" class="layout_navbar_hamburger"><div></div><div></div><div></div></label><div class="layout_nav_links"><a href="/articles">Articles</a><a href="/photography">Photos</a><a href="/projects">Projects</a><a href="/talks">Talks</a><a href="/articles/bookmarks">Bookmarks</a><a href="/about">About</a></div></div></div><div class="layout_transient_space"><div class="layout_nav_links"><a href="/articles">Articles</a><a href="/photography">Photos</a><a href="/projects">Projects</a><a href="/talks">Talks</a><a href="/articles/bookmarks">Bookmarks</a><a href="/about">About</a></div><p>This is a transient space.</p></div><div class="layout_content_container"><div class="layout_hero" style="--layout-object-fit-h:70%;--layout-object-fit-v:70%;--layout-hero-fraction:0.7"><picture class="image_picture"><source srcSet="/images/5d4b9c5e9d53d28fa2aedc785041d70d_400_266.webp 400w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_800_533.webp 800w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_1200_800.webp 1200w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_1600_1067.webp 1600w" type="image/webp" width="400" height="266" media="(orientation: landscape)"/><source srcSet="/images/5d4b9c5e9d53d28fa2aedc785041d70d_70_400_533.webp 400w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_70_800_1066.webp 800w" type="image/webp" width="400" height="533" media="(orientation: portrait) and (max-width: 500px)"/><img srcSet="/images/5d4b9c5e9d53d28fa2aedc785041d70d_400_266.webp 400w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_800_533.webp 800w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_1200_800.webp 1200w,/images/5d4b9c5e9d53d28fa2aedc785041d70d_1600_1067.webp 1600w" width="400" height="266" style="background-image:radial-gradient(67% 67% at 25% 25%, #bac5da, transparent),radial-gradient(67% 67% at 50% 25%, #c6d2e5, transparent),radial-gradient(67% 67% at 75% 25%, #aebacf, transparent),radial-gradient(67% 67% at 25% 50%, #797475, transparent),radial-gradient(67% 67% at 50% 50%, #918785, transparent),radial-gradient(67% 67% at 75% 50%, #766966, transparent),radial-gradient(67% 67% at 25% 75%, #5b3b1c, transparent),radial-gradient(67% 67% at 50% 75%, #754f2f, transparent),radial-gradient(67% 67% at 75% 75%, #6b4829, transparent),linear-gradient(#8b817d);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat" loading="eager"/></picture><div class="layout_hero_children"><div class="title_in_hero"><h1>Docker: Breathing Life into Decades old Fortran</h1><hr/><h2>Sunday, 6th April, 2025</h2></div></div></div><div class="layout_content"><div class="article_page_markdown"><div class="markdown_body"><div class="half_image_image"><div class="half_element_wrapper"><div class="half_element_before"></div><div class="half_element_element"><picture class="image_picture"><img srcSet="/images/c238547f24cef4aeb36217f569afdd2f_400_560.webp 400w,/images/c238547f24cef4aeb36217f569afdd2f_800_1120.webp 800w,/images/c238547f24cef4aeb36217f569afdd2f_1026_1437.webp 1026w" width="400" height="560" style="background-image:radial-gradient(67% 67% at 25% 25%, #f5f5f5, transparent),radial-gradient(67% 67% at 50% 25%, #f3f3f3, transparent),radial-gradient(67% 67% at 75% 25%, #f6f6f6, transparent),radial-gradient(67% 67% at 25% 50%, #f9f9f9, transparent),radial-gradient(67% 67% at 50% 50%, #fafafa, transparent),radial-gradient(67% 67% at 75% 50%, #fafafa, transparent),radial-gradient(67% 67% at 25% 75%, #fafafa, transparent),radial-gradient(67% 67% at 50% 75%, #f5f5f5, transparent),radial-gradient(67% 67% at 75% 75%, #fafafa, transparent),linear-gradient(#f8f8f8);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat"/></picture></div><div class="half_element_after"></div></div></div>
<p>The other day a friend came by: &quot;Do you know some Fortran90?&quot;
She was reading &quot;Introduction to Conventional Transmission Electron Microscopy&quot; by Prof. Marc De Graef and wanted to reproduce Fig.3.5 on the right (or above on mobile).
That figure is rendered by <a href="https://github.com/christopher-besch/ctemsoft/blob/main/src/lens.f90">lens.f90</a>.
Thing is, I don&#x27;t have any experience with Fortran or electron microscopy for that matter.
The code is two decades old and the documentation slim.</p>
<p>So what do you do?
You spin up a new Docker <em>container</em> and start hacking.
Naturally, you like Debian so go with that and download the <a href="https://ctem.web.cmu.edu">original code</a> into the current working directory:</p>
<pre><code class="language-bash">docker run --name ctemsoft -ti -v .:/code debian
</code></pre>
<p>This creates a new Docker <em>container</em> off of the Debian <em>image</em> and jumps you into a bash shell inside that <em>container</em>.
Once you&#x27;ve figured out what commands make that Fortran code compile you can write them to <del>your diary</del> a <em>Dockerfile</em>.
A <em>Dockerfile</em> specifies how an <em>image</em> is to be built allowing someone else to pick up your work where you left it off.</p>
<p>Docker, if you don&#x27;t already know, is great for these sorts of things.
When you need a reproducible environment a virtual machine is too big a gun most of the time.
Docker is a lot more efficient and offers more rapid turnaround times.
And still, when &quot;it works on my machine&quot; using Docker, it&#x27;ll work on yours too, using Docker.</p>
<p>Unfortunately, this amazing tool doesn&#x27;t save you from compilation errors and figuring out what dependencies you need and how to get them.
Some <a href="https://stackoverflow.com/questions/19916119/how-do-i-find-where-a-symbol-is-defined-among-static-libraries">stackoverflow</a> might help:</p>
<pre><code class="language-bash">find / -name <span class="pl-cce">\*</span>.a -exec bash -c <span class="pl-s"><span class="pl-pds">&quot;</span>nm --defined-only {} 2&gt;/dev/null | grep &#x27;cgetrf_&#x27; &amp;&amp; echo {}<span class="pl-pds">&quot;</span></span> <span class="pl-cce">\;</span>
</code></pre>
<p>After patching the code a couple of times you get it to compile.
For the runtime errors you mail Prof. De Graef and are eternally grateful for his kind support.
Seriously, do get in touch with people!
The patched code is on <a href="https://github.com/christopher-besch/ctemsoft">github.com/christopher-besch/ctemsoft</a>.</p>
<p>In the end you&#x27;ll have this <em>Dockerfile</em>, split into two stages:</p>
<ol>
<li>The compilation stage:
Here you need the compiler and some build dependencies.
All you do is copy the source code over into the <em>container</em> and run <code>make all</code> to compile.
The final binary will be in <code>/code/exe/lens</code>.</li>
<li>You need that binary in the second container so you copy it over and install some runtime dependencies.
This includes Python which we&#x27;ll get to just below.</li>
</ol>
<pre><code class="language-dockerfile"><span class="pl-c"># compilation stage</span>
<span class="pl-k">FROM</span> debian AS builder

<span class="pl-k">RUN</span> apt-get update &amp;&amp; \
    apt-get -y install \
    make \
    gfortran \
    liblapack3 \
    libblas3 \
    liblapack-dev \
    libblas-dev

<span class="pl-k">RUN</span> mkdir -p /code/exe
<span class="pl-k">COPY</span> ./src/ /code/src

<span class="pl-k">WORKDIR</span> /code/src
<span class="pl-k">RUN</span> make all

<span class="pl-c"># Python runtime stage</span>
<span class="pl-k">FROM</span> debian

<span class="pl-k">RUN</span> apt-get update &amp;&amp; \
    apt-get -y install \
    libgfortran5 \
    python3 \
    python3-numpy \
    ghostscript \
    ffmpeg

<span class="pl-k">COPY</span> --from=builder /code/exe/lens \
    /usr/bin/lens
<span class="pl-k">COPY</span> ./python_src/ /python_src
<span class="pl-k">WORKDIR</span> /python_src
<span class="pl-k">ENTRYPOINT</span> [<span class="pl-s">&quot;/bin/python3&quot;</span>, <span class="pl-s">&quot;/python_src/main.py&quot;</span>]
</code></pre>
<h1 id="lets-make-it-twirl"><a aria-hidden="true" tabindex="-1" class="markdown_heading_a" href="#lets-make-it-twirl"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Let&#x27;s make it twirl!</h1>
<div class="half_element_wrapper"><div class="half_element_before"></div><div class="half_element_element"><p class="half_video_removed_warn">[video removed from print]</p><video class="half_video_video" controls="" loop="" muted="" autoPlay="" playsInline="" width="1920" height="1080"><source src="/videos/13e35376e83adb1f9de7ec7181e921ec.mp4" type="video/mp4"/></video></div><div class="half_element_after"></div></div>
<p>lens.f90 takes in a bunch of configuration parameters: the magnetic field strength your electron microscope boasts and the number of sampling points for example.
Let&#x27;s interpret these parameters as a vector in the six-dimensional (or nine-dimensional if you have two fields) configuration space.
Now you can interpolate from one configuration to another:
Just take the vector representation of the first and last configuration and linearly interpolate.
You can choose how many intermediate frames you want and run lens.f90 for each of them.
This makes a video!</p>
<p>Writing a <a href="https://github.com/christopher-besch/ctemsoft/blob/main/python_src/main.py">Python script</a> is probably a great idea.
<a href="https://docs.python.org/3/library/subprocess.html"><code>subprocess.Popen</code></a> is pretty neat for starting lens.f90 as it reads the configuration from stdin.</p>
<pre><code class="language-py">proc <span class="pl-k">=</span> subprocess.Popen(
    <span class="pl-s"><span class="pl-pds">&quot;</span>lens<span class="pl-pds">&quot;</span></span>,
    <span class="pl-v">stdin</span><span class="pl-k">=</span>subprocess.<span class="pl-c1">PIPE</span>,
)
proc.communicate(<span class="pl-v">input</span><span class="pl-k">=</span><span class="pl-c1">str</span>.encode(input_str))
</code></pre>
<p>You can even start multiple renderings at the same time and properly parallelize this baby — if you&#x27;ve already burned four hours on this maybe save two minutes twiddling your thumbs?
lens.f90 creates a bunch of Postscript files as a result.</p>
<p>With Ghostscript you convert these Postscript files to PNGs.</p>
<pre><code class="language-py">subprocess.Popen(
    [
        <span class="pl-s"><span class="pl-pds">&quot;</span>gs<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-dSAFER<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-dEPSCrop<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-k">f</span><span class="pl-pds">&quot;</span>-r150<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-sDEVICE=pngalpha<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-o<span class="pl-pds">&quot;</span></span>,
        <span class="pl-c1">input</span>.output_png_file,
        <span class="pl-c1">input</span>.output_ps_file,
    ],
)
</code></pre>
<p>And now you use ffmpeg to convert the PNGs to an MP4.
Getting ffmpeg to spit out MP4s that can be played by anything other than VLC always takes some wiggling around.
This is what you come up with:</p>
<pre><code class="language-py">subprocess.Popen(
    [
        <span class="pl-s"><span class="pl-pds">&quot;</span>ffmpeg<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-framerate<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-k">f</span><span class="pl-pds">&quot;</span>30<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-i<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-k">f</span><span class="pl-pds">&quot;</span>./out/%03d.png<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-vcodec<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>libx264<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-f<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>mp4<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-vb<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>1024k<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-preset<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>slow<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>-pix_fmt<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>yuv420p<span class="pl-pds">&quot;</span></span>,
        <span class="pl-s"><span class="pl-pds">&quot;</span>./out/lens.mp4<span class="pl-pds">&quot;</span></span>,
    ],
)
</code></pre>
<p>If you&#x27;d been especially fancy you could&#x27;ve used more than two configuration vectors and a spline interpolation instead of the lerp.
But you already consumed all your fancyness on some over-engineered application-design with way too many structs, so you don&#x27;t.</p>
<h1 id="conclusion"><a aria-hidden="true" tabindex="-1" class="markdown_heading_a" href="#conclusion"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Conclusion</h1>
<p>With the (patched) Fortran code, the <em>Dockerfile</em> and the Python script everyone can reproduce the compilation:
Check out the <a href="https://github.com/christopher-besch/ctemsoft">Git Repo</a> and run Docker:</p>
<pre><code class="language-bash">git clone https://github.com/christopher-besch/ctemsoft
<span class="pl-c1">cd</span> ctemsoft
<span class="pl-c"># [edit python_src/main.py to your liking]</span>
docker build -t chrisbesch/ctemsoft <span class="pl-c1">.</span>
docker run -v ./out:/python_src/out chrisbesch/ctemsoft
vlc out/lens.mp4
</code></pre>
<p>And now you have made an animated video out of decades old code in a language you don&#x27;t know in a way people will be able to understand for decades to come.</p>
<p>So when you&#x27;re creating something of your own consider creating a <em>Dockerfile</em> for that, too.</p>
<!-- -->
<div class="markdown_spacer"></div></div></div><div class="title_in_text"><h1>Other Articles</h1><hr/></div><div class="articles_list"><a class="articles_list_card" href="/articles/lvim_in_distrobox"><picture class="image_picture"><img srcSet="/images/7b55476245f182a8e9f9b7e91efbb1a6_400_200.webp 400w,/images/7b55476245f182a8e9f9b7e91efbb1a6_800_400.webp 800w,/images/7b55476245f182a8e9f9b7e91efbb1a6_1200_600.webp 1200w,/images/7b55476245f182a8e9f9b7e91efbb1a6_1280_640.webp 1280w" width="400" height="200" style="background-image:radial-gradient(67% 67% at 25% 25%, #20242a, transparent),radial-gradient(67% 67% at 50% 25%, #21282f, transparent),radial-gradient(67% 67% at 75% 25%, #1f2329, transparent),radial-gradient(67% 67% at 25% 50%, #20252b, transparent),radial-gradient(67% 67% at 50% 50%, #20242a, transparent),radial-gradient(67% 67% at 75% 50%, #20252c, transparent),radial-gradient(67% 67% at 25% 75%, #222830, transparent),radial-gradient(67% 67% at 50% 75%, #232c35, transparent),radial-gradient(67% 67% at 75% 75%, #232c34, transparent),linear-gradient(#21272f);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat"/></picture><h1>LunarVim in Distrobox</h1><h2>Tuesday, 25th October, 2022</h2><hr/><p> You&#x27;re missing that one program that isn&#x27;t available in your Linux distro? With Distrobox, the &#x27;Linux Subsystem for Linux,&#x27; you can install it anyways. This article explains how to do that with the example of installing LunarVim on Red Hat. </p></a><a class="articles_list_card" href="/articles/technical_compromises"><picture class="image_picture"><img srcSet="/images/3548ef292f5ade7df6bc737602d59bd8_400_200.webp 400w,/images/3548ef292f5ade7df6bc737602d59bd8_800_400.webp 800w,/images/3548ef292f5ade7df6bc737602d59bd8_1200_600.webp 1200w,/images/3548ef292f5ade7df6bc737602d59bd8_1280_640.webp 1280w" width="400" height="200" style="background-image:radial-gradient(67% 67% at 25% 25%, #475764, transparent),radial-gradient(67% 67% at 50% 25%, #4a5b68, transparent),radial-gradient(67% 67% at 75% 25%, #4a5c68, transparent),radial-gradient(67% 67% at 25% 50%, #2b3c4d, transparent),radial-gradient(67% 67% at 50% 50%, #46505b, transparent),radial-gradient(67% 67% at 75% 50%, #847b70, transparent),radial-gradient(67% 67% at 25% 75%, #1d242a, transparent),radial-gradient(67% 67% at 50% 75%, #55483e, transparent),radial-gradient(67% 67% at 75% 75%, #665648, transparent),linear-gradient(#4b5155);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat"/></picture><h1>The Bitter Feeling of Technical Compromises</h1><h2>Thursday, 25th September, 2025</h2><hr/><p> My very personal troubles dealing with compromises, explained at an example of docker_cron with Renovate.
Sometimes you really don&#x27;t have to worry as much and trust your previous, careful considerations. </p></a><a class="articles_list_card" href="/articles/svg_fonts_with_sed"><picture class="image_picture"><img srcSet="/images/f59a7f43e2f2a641d46f9fd994b5589c_400_200.webp 400w,/images/f59a7f43e2f2a641d46f9fd994b5589c_800_400.webp 800w,/images/f59a7f43e2f2a641d46f9fd994b5589c_1200_600.webp 1200w,/images/f59a7f43e2f2a641d46f9fd994b5589c_1280_640.webp 1280w" width="400" height="200" style="background-image:radial-gradient(67% 67% at 25% 25%, #f5f6f6, transparent),radial-gradient(67% 67% at 50% 25%, #d6dbdf, transparent),radial-gradient(67% 67% at 75% 25%, #dadfe4, transparent),radial-gradient(67% 67% at 25% 50%, #b6b8ae, transparent),radial-gradient(67% 67% at 50% 50%, #614349, transparent),radial-gradient(67% 67% at 75% 50%, #604c4d, transparent),radial-gradient(67% 67% at 25% 75%, #d3d6c9, transparent),radial-gradient(67% 67% at 50% 75%, #bca298, transparent),radial-gradient(67% 67% at 75% 75%, #8b756c, transparent),linear-gradient(#b4aca9);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat"/></picture><h1>Inject Fonts into Web SVGs with sed</h1><h2>Monday, 10th February, 2025</h2><hr/><p> Add font-loading CSS to SVGs with a sed script. </p></a><a class="articles_list_card" href="/articles/github_pages_hack"><picture class="image_picture"><img srcSet="/images/2429205e42d7ecf6646d20aea86a90ce_400_200.webp 400w,/images/2429205e42d7ecf6646d20aea86a90ce_800_400.webp 800w,/images/2429205e42d7ecf6646d20aea86a90ce_1200_600.webp 1200w,/images/2429205e42d7ecf6646d20aea86a90ce_1280_640.webp 1280w" width="400" height="200" style="background-image:radial-gradient(67% 67% at 25% 25%, #e6e8ed, transparent),radial-gradient(67% 67% at 50% 25%, #f5f5f7, transparent),radial-gradient(67% 67% at 75% 25%, #f8f8f8, transparent),radial-gradient(67% 67% at 25% 50%, #eef2f2, transparent),radial-gradient(67% 67% at 50% 50%, #f8f9f9, transparent),radial-gradient(67% 67% at 75% 50%, #fbfafa, transparent),radial-gradient(67% 67% at 25% 75%, #edf0f1, transparent),radial-gradient(67% 67% at 50% 75%, #f7f7f7, transparent),radial-gradient(67% 67% at 75% 75%, #f6f8f9, transparent),linear-gradient(#f4f5f6);background-position:0 0, 0 100%;background-size:100% 100%;background-repeat:no-repeat"/></picture><h1>How my GitHub Pages got Hacked</h1><h2>Saturday, 18th October, 2025</h2><hr/><p> A DNS forward is an expression of trust. GitHub broke my trust and someone else received control over my domain. </p></a></div><a class="button" href="/articles">Furthermore Articles</a></div></div><div class="layout_footer"><a href="/about">Contact</a><a href="/rss.xml">RSS</a><a href="/privacy">Privacy</a><div>© 2025 | All rights reserved</div></div></body></html>