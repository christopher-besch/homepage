{"componentChunkName":"component---src-templates-article-tsx-content-file-path-src-articles-12-riscv-rt-riscv-rt-md","path":"/articles/riscv_rt/","result":{"data":{"mdx":{"body":"\nimport kernel_config from \"./kernel_config.png\";\nimport general_setup_config from \"./general_setup_config.png\";\nimport preemption_model_config from \"./preemption_model_config.png\";\n\nI got access to a StarFive VisionFive 2 and wanted to play around with Real-Time Linux on it.\nThis article goes into excruciating detail on how I set that machine up to with `PREEMPT_RT`.\n\nThe first mainline Kernel with PREEMPT_RT is v6.12.\nAt the time of writing v6.15 is the newest kernel and my Debian laptop runs on v6.1.0.\nFor the Debian user that I am v6.12 is pretty new.\n\nSo, how do we get this single board computer (SBC) to work and run on such a new kernel?\nThere is no StarFive Debian release with a Linux kernel v6.12 or newer.\nSo we need to make due with engineering release 202409 and kernel v6.6.20 and get to v6.12 later.\n(That's still newer than my Debian laptop...)\n\n# Installing the Initial Image\nI just stick to the [official installation guide for Debian on the VisionFive 2](https://rvspace.org/en/project/VisionFive2_Debian_User_Guide).\nI chose to boot off of an SD card, pop it in my laptop and run:\n```bash\nbzip2 -d starfive-jh7110-202409-SD-minimal-desktop-wayland.img.bz2\nsudo dd if=starfive-jh7110-202409-SD-minimal-desktop-wayland.img of=/dev/sda conv=fsync bs=4M status=progress\n```\nNow we can insert the SD card into the SBC and watch it boot for the first time.\n\n# UART\nI have a USB to UART adapter attached to my laptop and the SBC.\nAfter having added myself to the dialout group on my laptop I rebooted (a relogin would have done it as well):\n```bash\nsudo usermod -a -G dialout chris\nsudo reboot\n```\n\nNow I plug in the adapter to my laptop and check what tty adapter it is on:\n```bash\nsudo dmesg\n```\nThis should print something including the tty path.\nI use this path to attach a terminal to that adapter.\n```bash\nscreen -U /dev/ttyUSB0 -b 115200\n```\nExit with `Ctrl+a d`.\n\nThere is this magic of LEDs on a UART adapter blinking as you type.\n\n# Setting up Networking\n\nLinux is running on the SBC but I'd like to have network access.\nI have my Linux Laptop right here and want to share its network connection with the SBC.\n\n## On the Laptop\nFirst we need to know what network cards we're dealing with:\n```bash\n~ λ ip link\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: wlp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP mode DORMANT group default qlen 1000\n    link/ether 10:6f:d9:1e:4f:e1 brd ff:ff:ff:ff:ff:ff\n3: enx00133bb15f5b: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP mode DEFAULT group default qlen 1000\n    link/ether 00:13:3b:b1:5f:5b brd ff:ff:ff:ff:ff:ff```\n```\nAs you can see I have three network cards, the loopback device (i.e. for localhost) my wifi card `wlp1s0` and a usb LAN adapter `enx00133bb15f5b`.\n\n### NAT Setup\nWe need to setup NAT to forward packets meant for the SBC with the laptop.\n```bash\nsudo sysctl -w net.ipv4.ip_forward=1\nsudo iptables -t nat -A POSTROUTING -o wlp1s0 -j MASQUERADE\nsudo iptables -A FORWARD -i enx00133bb15f5b -o wlp1s0 -j ACCEPT\nsudo iptables -A FORWARD -i wlp1s0 -o enx00133bb15f5b -m state --state RELATED,ESTABLISHED -j ACCEPT\n```\n\n### IP Addresses\nWe want to assign a new IP address for the laptop to the `enx00133bb15f5b` link.\n```bash\nsudo ip addr add 192.168.10.1/24 dev enx00133bb15f5b\nsudo ip link set enx00133bb15f5b up\n```\n\nI check that this worked with:\n```bash\n~ λ ip addr\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host noprefixroute\n       valid_lft forever preferred_lft forever\n2: wlp1s0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000\n    link/ether 10:6f:d9:1e:4f:e1 brd ff:ff:ff:ff:ff:ff\n    inet 172.17.65.91/17 brd 172.17.127.255 scope global dynamic noprefixroute wlp1s0\n       valid_lft 1694sec preferred_lft 1694sec\n    inet6 2a00:1398:9:fb03:c786:4d2:ce2e:e30d/64 scope global dynamic noprefixroute\n       valid_lft 2591999sec preferred_lft 604799sec\n    inet6 fe80::cebf:38eb:9589:c3a0/64 scope link noprefixroute\n       valid_lft forever preferred_lft forever\n3: enx00133bb15f5b: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc fq_codel state UP group default qlen 1000\n    link/ether 00:13:3b:b1:5f:5b brd ff:ff:ff:ff:ff:ff\n    inet 192.168.10.1/24 scope global enx00133bb15f5b\n       valid_lft forever preferred_lft forever\n```\nThe `enx00133bb15f5b` link has a new IP address (192.168.10.1) assigned to it.\n\n## On the SBC\n```bash\nuser@starfive:~$ ip link\n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN mode DEFAULT group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 6c:cf:39:00:49:50 brd ff:ff:ff:ff:ff:ff\n    altname end0\n3: eth1: <NO-CARRIER,BROADCAST,MULTICAST,UP> mtu 1500 qdisc mq state DOWN mode DEFAULT group default qlen 1000\n    link/ether 6c:cf:39:00:49:51 brd ff:ff:ff:ff:ff:ff\n    altname end1\n4: sit0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN mode DEFAULT group default qlen 1000\n    link/sit 0.0.0.0 brd 0.0.0.0\n```\n\nI have attached the LAN cable to the `eth0` network card.\n\n```bash\nsudo ip addr add 192.168.10.2/24 dev eth0\nsudo ip link set eth0 up\nsudo ip route add default via 192.168.10.1\n```\nWith this we have added the ip `192.168.10.2` to the SBC's `eth0` interface.\nDHCP would have done that automatically but we didn't setup a DHCP server on the laptop so we have to do this manually.\n\n### DNS\n\n```bash\nsudo vi /etc/resolv.conf\n```\n\nAdd this line (we all like Google, don't we?):\n```\nnameserver 8.8.8.8\n```\n\nWe don't need the NetworkManager for this, btw.\nFeel free to disable it:\n```bash\nsudo systemctl disable --now NetworkManager\n```\n\n### Let's Test this\n```bash\n# ping the laptop\n# this tests the link works\nping 192.168.10.1\n# ping google infrastructure without the DNS\n# this tests the NAT works\nping 8.8.8.8\n# ping google with DNS\n# this tests that the DNS works\nping google.com\n```\n\nThis setup works most of the time.\nSometimes it's a bit flaky.\nI presume that's because the NetworkManager on my laptop interferes but I'm not sure and can't turn it off there.\nI often have to run the commands multiple times until they stick.\n\n### SSH\nThere already is an SSH server installed and running on the SBC.\nAll I have to do is connect to it from the host:\n```bash\nssh user@192.168.10.2\n```\nSo much faster than UART, damn!\nNo blinking lights, though `:<`\n\n# Building the Kernel\nAgain we refer to the [VisionFive 2 docs](https://rvspace.org/en/project/VisionFive2_Debian_User_Guide#h-46-compiling-and-updating-linux-kernel).\n```bash\nsudo apt-get -y install build-essential linux-source bc kmod cpio flex libncurses5-dev libelf-dev libssl-dev dwarves bison git debhelper\ngit clone --depth 1 --single-branch --branch JH7110_VisionFive2_6.12.y_devel https://github.com/starfive-tech/linux\ncd linux\ncp arch/riscv/configs/starfive_visionfive2_defconfig .config\nmake ARCH=riscv olddefconfig\n```\n\nNow we need to configure PREEMPT_RT:\n```bash\nmake ARCH=riscv menuconfig\n```\n\n<HalfImage src={preemption_model_config} />\n\nIn this menu screen we select **Scheduler controlled preemption model** mode under **General setup** then **Preemption Model**.\nIn my case I also had to set this in the `.config` file in order to differentiate this kernel from a `PREEMPT_DYNAMIC` build I also created.\n```\nCONFIG_LOCALVERSION=\"preempt-rt\"\n```\n\nBack to the documentation and we start the compilation:\n```bash\nmake ARCH=riscv -j$(nproc) bindeb-pkg\n# for me the .deb files ended up being in the $HOME directory\ncd ..\nsudo dpkg -i \\\n    linux-headers-6.12.5*_riscv64.deb \\\n    linux-image-6.12.5*_riscv64.deb \\\n    linux-libc-dev_6.12.5*_riscv64.deb\n```\nWhen doing so more than once, I had to uninstall an old kernel; probably because there isn't enough space for the rgx firmware on initrd but I'm really not sure.\n\nThis takes a while — some time to do the toilet, nice.\nStill not done?\nThen I have some time to write this article, also nice.\nMaybe I should've crosscompiled on my laptop.\nCompiling the Linux kernel on a computer that doesn't even have a heat-sink is something...\nThat took roughly an hour.\n\nSome notes:\nThe documentation warns about the dtbs not being synced but for me they were, so I left that as is and rebooted.\nInstalling `debhelper` was missing in the documentation.\n\n## Dealing with Multiple Kernels\nI ended up having two v6.12.5 kernels installed: a `PREEMPT_RT` and a `PREEMPT_DYNAMIC` one.\nTo choose which one to boot I edited `/boot/extlinux/extlinux.conf`.\nIt has such a nice warning not to edit it.\nHere I just renamed the `l0` and `l0r` labels to `l1` and `l1r` and the other way around.\nI also rearranged the labels to be a little nicer; I have no idea if that was needed.\n\nI did try using a *proper* method of changing the kernel to boot but this was the only thing I came up with and it works.\nI left the `l2` and `l2r` labels in case I screwed something up.\n\n```bash\nsudo vi /boot/extlinux/extlinux.conf\n```\n\n```\n## /extlinux/extlinux.conf\n##\n## IMPORTANT WARNING\n##\n## The configuration of this file is generated automatically.\n## Do not edit this file manually, use: u-boot-update\n\ndefault l0\nmenu title U-Boot menu\nprompt 0\ntimeout 50\n\n\nlabel l0\n        menu label Debian GNU/Linux trixie/sid 6.12.5preempt-rt+\n        linux /vmlinuz-6.12.5preempt-rt+\n        initrd /initrd.img-6.12.5preempt-rt+\n        fdtdir /dtbs/6.12.5preempt-rt+\n\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0\n\nlabel l0r\n        menu label Debian GNU/Linux trixie/sid 6.12.5preempt-rt+ (rescue target)\n        linux /vmlinuz-6.12.5preempt-rt+\n        initrd /initrd.img-6.12.5preempt-rt+\n        fdtdir /dtbs/6.12.5preempt-rt+\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0 single\n\n\nlabel l1\n        menu label Debian GNU/Linux trixie/sid 6.12.5+\n        linux /vmlinuz-6.12.5+\n        initrd /initrd.img-6.12.5+\n        fdtdir /dtbs/6.12.5+\n\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0\n\nlabel l1r\n        menu label Debian GNU/Linux trixie/sid 6.12.5+ (rescue target)\n        linux /vmlinuz-6.12.5+\n        initrd /initrd.img-6.12.5+\n        fdtdir /dtbs/6.12.5+\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0 single\n\n\nlabel l2\n        menu label Debian GNU/Linux trixie/sid 6.6.20-starfive\n        linux /vmlinuz-6.6.20-starfive\n        initrd /initrd.img-6.6.20-starfive\n        fdtdir /dtbs/6.6.20-starfive\n\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0\n\nlabel l2r\n        menu label Debian GNU/Linux trixie/sid 6.6.20-starfive (rescue target)\n        linux /vmlinuz-6.6.20-starfive\n        initrd /initrd.img-6.6.20-starfive\n        fdtdir /dtbs/6.6.20-starfive\n        append root=/dev/mmcblk1p4 root=/dev/mmcblk1p4 rw console=tty0 console=ttyS0,115200 earlycon rootwait stmmaceth=chain_mode:1 selinux=0 single\n```\n\n# Testing\nNow we can do some testing of our real-time performance with cyclictest:\n```bash\nsudo apt install rt-tests stress-ng\nsudo echo performance > /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor\n# cpu\nstress-ng --matrix 4\n# mem\nstress-ng --vm 4\nsudo cyclictest --mlockall --smp --priority=99 --interval=200 --quiet --duration=10m --histofall=200 > out.txt\n```\n\n# Some Ideas for Further Investigation\n- disable `CONFIG_NO_HZ_IDLE`\n- use `CONFIG_HZ_1000` instead of `CONFIG_HZ_100`\n\n# Other Things\nTo get my custom configs to work I had to edit my `.bash_profile`: [unix.stackexchange.com/questions/94490/bash-doesnt-read-bashrc-unless-manually-started](https://unix.stackexchange.com/questions/94490/bash-doesnt-read-bashrc-unless-manually-started)\n","frontmatter":{"date":"Friday, 27th June, 2025","title":"Real-Time Linux on RISC-V","description":" Setting up Linux v6.12 on a StarFive VisionFive 2 with PREEMPT_RT.\nAlso: How to setup your Linux laptop as a simple NAT router. ","banner":"/social_banner/riscv_rt.png","title_banner":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAALABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAMBAgT/xAAWAQEBAQAAAAAAAAAAAAAAAAAAAgP/2gAMAwEAAhADEAAAAWMzszqCof/EABgQAAMBAQAAAAAAAAAAAAAAAAABEgIQ/9oACAEBAAEFAltFFC7/AP/EABURAQEAAAAAAAAAAAAAAAAAAAAS/9oACAEDAQE/AZS//8QAFhEBAQEAAAAAAAAAAAAAAAAAABIB/9oACAECAQE/AbXr/8QAFhAAAwAAAAAAAAAAAAAAAAAAACAx/9oACAEBAAY/AiL/AP/EABoQAAICAwAAAAAAAAAAAAAAAAABEVEhMXH/2gAIAQEAAT8h6hrYeWhVRCog/9oADAMBAAIAAwAAABCrH//EABURAQEAAAAAAAAAAAAAAAAAAAAR/9oACAEDAQE/EIQ//8QAFxEBAAMAAAAAAAAAAAAAAAAAABFRYf/aAAgBAgEBPxCdMn//xAAbEAEAAwADAQAAAAAAAAAAAAABABEhMUGRcf/aAAgBAQABPxBVJfxsUZpC7fZqxkbgpEXweT//2Q=="},"images":{"fallback":{"src":"/static/88614c35096baae868e5bee70286469f/a764f/alpha_yankee.jpg","srcSet":"/static/88614c35096baae868e5bee70286469f/fb67e/alpha_yankee.jpg 480w,\n/static/88614c35096baae868e5bee70286469f/3059d/alpha_yankee.jpg 960w,\n/static/88614c35096baae868e5bee70286469f/a764f/alpha_yankee.jpg 1920w","sizes":"(min-width: 1920px) 1920px, 100vw"},"sources":[{"srcSet":"/static/88614c35096baae868e5bee70286469f/3a3a2/alpha_yankee.webp 480w,\n/static/88614c35096baae868e5bee70286469f/bde8a/alpha_yankee.webp 960w,\n/static/88614c35096baae868e5bee70286469f/c512e/alpha_yankee.webp 1920w","type":"image/webp","sizes":"(min-width: 1920px) 1920px, 100vw"}]},"width":1920,"height":1080}}},"title_banner_horizontal_position":"20%","title_banner_vertical_position":"40%","version":"1.0.0"}}},"pageContext":{"id":"72bffb93-08aa-5791-bd9c-915fef145ff0","frontmatter":{"type":"article","title":"Real-Time Linux on RISC-V","description":" Setting up Linux v6.12 on a StarFive VisionFive 2 with PREEMPT_RT.\nAlso: How to setup your Linux laptop as a simple NAT router. ","banner":"/social_banner/riscv_rt.png","thumb":"../../../static/social_banner/riscv_rt.png","title_banner":"../../images/photography/alpha_yankee.jpg","title_banner_horizontal_position":"20%","title_banner_vertical_position":"40%","slug":"riscv_rt","date":"2025-06-27T00:00:00.000Z","listed":true,"version":"1.0.0"}}},"staticQueryHashes":["1995789189","2480137602","475732191"],"slicesMap":{}}