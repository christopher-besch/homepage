{"componentChunkName":"component---src-templates-article-tsx-content-file-path-src-articles-17-forgejo-actions-notification-fogejo-actions-notification-md","path":"/articles/forgejo_actions_notification/","result":{"data":{"mdx":{"body":"\nForgejo is a code forge:\nJust like GitHub or GitLab it's a place to (collaboratively) develop software.\nBecause Forgejo is incredibly easy to self-host and I love it's Open-Source community, I chose it for my private code forge.\nI've already explained at length [why I love Open-Source](/articles/open_source) so much.\n\nWith my new code forge up and running there were a few features my team needed.\nSpecifically we needed to receive email notifications and webhooks when a CI Workflow failed.\nForgejo didn't offer that feature so I started contributing to Forgejo.\nThrough this article I want to give back as much of what I've learned in doing so.\nThe parts that took the most effort where\n- setting up a development environment,\n- understanding Forgejo's notification architecture,\n- actually implementing the features and\n- writing exhaustive tests for the features I implemented.\n\nBe aware that I'm describing all of this as of commit `b2c4fc9f94` (21.07.2025).\nSome of this information may be outdated for any newer state of the code base.\n\n## Development Setup\nTo test the features I developed I don't just need the Forgjeo executable.\nNo, I also need an action runner, a mail server and some place to send webhooks to.\nLet's start with just getting a Forgejo test instance up and running.\n1. I use Debian but this setup should work on all Linux distros (and maybe macOS and BSD?).\n2. [Install node and npm](https://github.com/nvm-sh/nvm?tab=readme-ov-file#install--update-script).\n3. [Install go](https://go.dev/doc/install).\n4. Install [gotestsum](https://github.com/gotestyourself/gotestsum).\n   This is entirely optional.\n   If you don't install gotestsum, ignore all the `USE_GOTESTSUM=yes` statements below.\n5. Download the [Forgejo Repo](https://codeberg.org/forgejo/forgejo) with `git clone https://codeberg.org/forgejo/forgejo ~/forgejo && cd ~/forgejo`.\n6. Build an executable with `STRIP=\"0\" EXTRA_GOFLAGS='-gcflags=\"all=-N -l\"' TAGS=\"sqlite sqlite_unlock_notify\" make build`.\n   It took me a while to realize that `go build` enables optimization by default but keeps all debug symbols present.\n   We change that with the `gsflags` by neither optimizing or inlining.\n   Furthermore, Forgejo's Makefile strips the debug symbols so we disable that with the `STRIP` environment variable.\n7. Run `./gitea`.\n   Yes, the executable is still called that.\n8. Open a webbrowser and navigate to [http://localhost:3000](http://localhost:3000).\n9. Choose SQLite, create an admin account and keep everything else default.\n   Your config is in `~/forgejo/custom/conf/app.ini`.\n10. Create the `test_repo` repository and add the file `.forgejo/workflows/main.yml`:\n    ```yaml\n    enable-email-notifications: true\n    on:\n      workflow_dispatch:\n    \n    jobs:\n      test:\n        runs-on: self-hosted\n        steps:\n          - name: Echo\n            run: |\n              echo Hello World!\n          - name: Fail\n            run: |\n              false\n    ```\n    You can make your life a little easier by cloning the repo: `git clone http://localhost:3000/chris_admin/test_repo.git ~forgejo_test_repo`.\n    You'll have to follow the prompts and configure your `user.email` and `user.name`.\n    I'm using password login, btw.\n11. Download the [Forgejo runner binary](https://code.forgejo.org/forgejo/runner/releases) into `~/forgejo_runner`.\n12. Register the runner with `./forgejo-runner-11.1.2-linux-amd64 register`, give the instance URL `http://localhost:3000`, the runner token you get from the repo settings in the web interface, choose a name like `test-runner` and select the label `self-hosted:host`.\n13. Run `./forgejo-runner-11.1.2-linux-amd64 daemon` and click the workflow trigger button in the web interface.\n    You should see your workflow run now.\n\nOkay, that works fine but we also want to test sending emails.\nI use [MailDev](https://github.com/maildev/maildev) to create a development email server.\nIt provides an SMTP server, which Forgejo connects to, and a webinterface for me, the developer.\n1. [Install Docker](https://docs.docker.com/engine/install).\n2. Run `docker run --network host -p 1080:1080 -p 1025:1025 maildev/maildev`.\n3. Open [http://localhost:1080](http://localhost:1080) in a webbrowser.\n4. Shutdown Forgejo and edit it's config (in `~/forgejo/custom/conf/app.ini`).\n   ```\n   [mailer]\n   ENABLED = true\n   PROTOCOL = smtp\n   SMTP_ADDR = localhost\n   SMTP_PORT = 1025\n   FROM = forgejo@localhost\n\n   # make sure this is true\n   [service]\n   ENABLE_NOTIFY_MAIL = true\n   ```\n5. Now, when the workflow fails you should get a mail in the MailDev web interface.\n\nFurthermore, we want to test webhooks.\n1. I'm using [this node script](https://stackoverflow.com/a/46787467) as a test webhook:\n   `webhook_tester.js`:\n   ```js\n   #!/usr/bin/env node\n\n   const http = require(\"http\");\n\n   const hostname = \"0.0.0.0\";\n   const port = 8001;\n\n   const server = http.createServer((req, res) => {\n     console.log(`\\n${req.method} ${req.url}`);\n     console.log(req.headers);\n\n     req.on(\"data\", function(chunk) {\n       console.log(\"BODY: \" + chunk);\n     });\n\n     res.statusCode = 200;\n     res.setHeader(\"Content-Type\", \"text/plain\");\n     res.end(\"Hello World\\n\");\n   });\n\n   server.listen(port, hostname, () => {\n     console.log(`Server running at http://localhost:${port}/`);\n   });\n   ```\n2. Run `./webhook_tester.js`.\n3. Shutdown Forgejo and edit it's config (in `~/forgejo/custom/conf/app.ini`).\n   For Forgejo to accept `http://localhost:8001` as a webhook target you need to add this:\n   ```ini\n   [webhook]\n   ALLOWED_HOST_LIST = *\n   SKIP_TLS_VERIFY = true\n   ```\n4. Create a new webhook in the Repo Settings and use the target URL `http://localhost:8001`.\n   Enable either *All events* or *Custom events*, selecting the *Action Run events*.\n5. Start the workflow, let it fail and watch the sent webhook in the node terminal.\n\n### Running All Tests\nForejeo has are different types of tests.\nI was concerned with these types.\n- Run all unit tests with `TAGS='sqlite sqlite_unlock_notify' USE_GOTESTSUM=yes make test`.\n- Run all integration tests with `TAGS='sqlite sqlite_unlock_notify' USE_GOTESTSUM=yes make test-sqlite`.\n\nThere are other types of tests, namely frontend tests and the End-to-End tests in a special repo.\nI didn't work with these yet so I direct you to the [testing docs](https://forgejo.org/docs/latest/contributor/testing).\n\n### Running Specific Tests\nSay you only want to run this unit test in `~/forgejo/models/actions/run_test.go`:\n```go\nfunc TestGetRunBefore(t *testing.T) {\n  // --snip--\n}\n```\nThen you can execute `USE_GOTESTSUM=yes TAGS='sqlite sqlite_unlock_notify' GO_TEST_PACKAGES='forgejo.org/models/actions' make 'test#TestGetRunBefore'`.\n\nIf you are concerned with this integration test in `~/forgejo/tests/integration/actions_notifications_test.go`:\n```go\nfunc TestActionNotifications(t *testing.T) {\n  // --snip--\n}\n```\nThen you can run `USE_GOTESTSUM=yes TAGS='sqlite sqlite_unlock_notify' make 'test-sqlite#TestActionNotifications'`.\n\n### Debugging Tests\nTODO\n\n`break forgejo.org/tests/integration.TestActionNotification`\n\n### Debugging\nI like the terminal and am used to GDB.\nTherefore I'm using the terminal debugger [Delve](https://github.com/go-delve/delve).\nLet's set things up for that:\n1. [Install Delve](https://github.com/go-delve/delve/tree/master/Documentation/installation).\n2. Build Forgejo as described [above](#development-setup).\n3. Run `dlv exec ./gitea`.\n4. Now we can use the Delve console.\n   For example you can do `break forgejo.org/services/mailer.(*mailNotifier).ActionRunNowDone`, `break forgejo.org/services/notify.ActionRunNowDone` and `continue`.\n   Hit `Ctrl+C` to enter a Delve command and type `quit` to exit.\n\n## Forgejo's Observer Pattern\nTODO\n\n- [Forgejo's architecture overview](https://forgejo.org/docs/next/contributor/architecture) is quite helpful.\n- duplicity of structs\n\n## My Changes\nTODO\n\n- [#7510: Refactoring](https://codeberg.org/forgejo/forgejo/pulls/7510)\n- [#7491: Actions Done Notification](https://codeberg.org/forgejo/forgejo/pulls/7491)\n- [#7697: After the Fact Cleanup](https://codeberg.org/forgejo/forgejo/pulls/7697)\n- [#7509: Actions Done Mail](https://codeberg.org/forgejo/forgejo/pulls/7509)\n- [#7508: Actions Done Webhook](https://codeberg.org/forgejo/forgejo/pulls/7508)\n- at same time to #7508 [#7699: (not mine) introduce ActionRun, too](https://codeberg.org/forgejo/forgejo/pulls/7508)\n- [#8066: (not mine) rename #7699's struct to RepoActionRun](https://codeberg.org/forgejo/forgejo/pulls/8066)\n- [#8250: (not mine) unify ActionRun and RepoActionRun](https://codeberg.org/forgejo/forgejo/pulls/8250)\n- [#8227: (not mine) Only single user receives mail](https://codeberg.org/forgejo/forgejo/pulls/8227)\n- [#8242: (not mine) actions mail opt-in](https://codeberg.org/forgejo/forgejo/pulls/8242)\n\n## Conclusion and Lessons Learned\nTODO\n\n- architecture of Forgejo notifications\n- importance of tests, what tests I wrote\n- testing setup, I didn't have that much time directly after all PRs -> tests vital\n- think of testing not as a side-gig!\n- break things up into multiple PRs\n- less code is better\n- understand as much as possible, then make the minimal change that is needed (knock someone out with your pinky)\n","frontmatter":{"date":"Thursday, 16th October, 2025","title":"Forgejo Actions Notification Development","description":" Some stories of how I work on Forgejo. ","banner":"/social_banner/testing.png","title_banner":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAgADBf/EABUBAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAHmIOMJx//EABkQAQEAAwEAAAAAAAAAAAAAAAEAERIhMf/aAAgBAQABBQJtZvXM9f/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABUQAQEAAAAAAAAAAAAAAAAAABAR/9oACAEBAAY/Amv/xAAZEAADAQEBAAAAAAAAAAAAAAAAAREhMVH/2gAIAQEAAT8hRchHpScMwCeUfQ//2gAMAwEAAgADAAAAEO/f/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHRABAQACAQUAAAAAAAAAAAAAAREAMSFBUWFxkf/aAAgBAQABPxAUAG7u7rFkCaUhfuJaETCBQzp4ygOPWImnYz//2Q=="},"images":{"fallback":{"src":"/static/a510114e0f227411627e203a1332f813/204db/alpha_whiskey.jpg","srcSet":"/static/a510114e0f227411627e203a1332f813/fa695/alpha_whiskey.jpg 480w,\n/static/a510114e0f227411627e203a1332f813/9f3ff/alpha_whiskey.jpg 960w,\n/static/a510114e0f227411627e203a1332f813/204db/alpha_whiskey.jpg 1920w","sizes":"(min-width: 1920px) 1920px, 100vw"},"sources":[{"srcSet":"/static/a510114e0f227411627e203a1332f813/95a23/alpha_whiskey.webp 480w,\n/static/a510114e0f227411627e203a1332f813/42d4c/alpha_whiskey.webp 960w,\n/static/a510114e0f227411627e203a1332f813/2136b/alpha_whiskey.webp 1920w","type":"image/webp","sizes":"(min-width: 1920px) 1920px, 100vw"}]},"width":1920,"height":1281}}},"title_banner_horizontal_position":"20%","title_banner_vertical_position":"80%","version":"1.0.0"}}},"pageContext":{"id":"984fd1f1-2796-5309-b9ae-4b47b7b08da8","frontmatter":{"type":"article","title":"Forgejo Actions Notification Development","description":" Some stories of how I work on Forgejo. ","banner":"/social_banner/testing.png","thumb":"../../../static/social_banner/testing.png","title_banner":"../../images/photography/alpha_whiskey.jpg","title_banner_horizontal_position":"20%","title_banner_vertical_position":"80%","slug":"forgejo_actions_notification","date":"2025-10-16T00:00:00.000Z","listed":true,"version":"1.0.0"}}},"staticQueryHashes":["1754054404","1995789189","475732191"],"slicesMap":{}}