{"componentChunkName":"component---src-templates-article-tsx-content-file-path-src-articles-10-ctemsoft-ctemsoft-md","path":"/articles/ctemsoft/","result":{"data":{"mdx":{"body":"import lens_video from \"./lens_cropped.mp4\";\nimport lens_3_5 from \"./lens_3_5_cropped.png\";\n\n<HalfImage src={lens_3_5} />\n\nThe other day a friend came by: \"Do you know some Fortran90?\"\nShe was reading \"Introduction to Conventional Transmission Electron Microscopy\" by Prof. Marc De Graef and wanted to reproduce Fig.3.5 on the right (or above on mobile).\nThat figure is rendered by [lens.f90](https://github.com/christopher-besch/ctemsoft/blob/main/src/lens.f90).\nThing is, I don't have any experience with Fortran or electron microscopy for that matter.\nThe code is two decades old and the documentation slim.\n\nSo what do you do?\nYou spin up a new Docker *container* and start hacking.\nNaturally, you like Debian so go with that and download the [original code](https://ctem.web.cmu.edu) into the current working directory:\n\n```bash\ndocker run --name ctemsoft -ti -v .:/code debian\n```\n\nThis creates a new Docker *container* off of the Debian *image* and jumps you into a bash shell inside that *container*.\nOnce you've figured out what commands make that Fortran code compile you can write them to <del>your diary</del> a *Dockerfile*.\nA *Dockerfile* specifies how an *image* is to be built allowing someone else to pick up your work where you left it off.\n\nDocker, if you don't already know, is great for these sorts of things.\nWhen you need a reproducible environment a virtual machine is too big a gun most of the time.\nDocker is a lot more efficient and offers more rapid turnaround times.\nAnd still, when \"it works on my machine\" using Docker, it'll work on yours too, using Docker.\n\nUnfortunately, this amazing tool doesn't save you from compilation errors and figuring out what dependencies you need and how to get them.\nSome [stackoverflow](https://stackoverflow.com/questions/19916119/how-do-i-find-where-a-symbol-is-defined-among-static-libraries) might help:\n\n```bash\nfind / -name \\*.a -exec bash -c \"nm --defined-only {} 2>/dev/null | grep 'cgetrf_' && echo {}\" \\;\n```\n\nAfter patching the code a couple of times you get it to compile.\nFor the runtime errors you mail Prof. De Graef and are eternally grateful for his kind support.\nSeriously, do get in touch with people!\nThe patched code is on [github.com/christopher-besch/ctemsoft](https://github.com/christopher-besch/ctemsoft).\n\nIn the end you'll have this *Dockerfile*, split into two stages:\n1.  The compilation stage:\n    Here you need the compiler and some build dependencies.\n    All you do is copy the source code over into the *container* and run `make all` to compile.\n    The final binary will be in `/code/exe/lens`.\n2.  You need that binary in the second container so you copy it over and install some runtime dependencies.\n    This includes Python which we'll get to just below.\n```dockerfile\n# compilation stage\nFROM debian AS builder\n\nRUN apt-get update && \\\n    apt-get -y install \\\n    make \\\n    gfortran \\\n    liblapack3 \\\n    libblas3 \\\n    liblapack-dev \\\n    libblas-dev\n\nRUN mkdir -p /code/exe\nCOPY ./src/ /code/src\n\nWORKDIR /code/src\nRUN make all\n\n# Python runtime stage\nFROM debian\n\nRUN apt-get update && \\\n    apt-get -y install \\\n    libgfortran5 \\\n    python3 \\\n    python3-numpy \\\n    ghostscript \\\n    ffmpeg\n\nCOPY --from=builder /code/exe/lens \\\n    /usr/bin/lens\nCOPY ./python_src/ /python_src\nWORKDIR /python_src\nENTRYPOINT [\"/bin/python3\", \"/python_src/main.py\"]\n```\n\n# Let's make it twirl!\n\n<AutoPlayVideo src={lens_video} />\n\nlens.f90 takes in a bunch of configuration parameters: the magnetic field strength your electron microscope boasts and the number of sampling points for example.\nLet's interpret these parameters as a vector in the six-dimensional (or nine-dimensional if you have two fields) configuration space.\nNow you can interpolate from one configuration to another:\nJust take the vector representation of the first and last configuration and linearly interpolate.\nYou can choose how many intermediate frames you want and run lens.f90 for each of them.\nThis makes a video!\n\nWriting a [Python script](https://github.com/christopher-besch/ctemsoft/blob/main/python_src/main.py) is probably a great idea.\n[`subprocess.Popen`](https://docs.python.org/3/library/subprocess.html) is pretty neat for starting lens.f90 as it reads the configuration from stdin.\n\n```py\nproc = subprocess.Popen(\n    \"lens\",\n    stdin=subprocess.PIPE,\n)\nproc.communicate(input=str.encode(input_str))\n```\n\nYou can even start multiple renderings at the same time and properly parallelize this baby â€” if you've already burned four hours on this maybe save two minutes twiddling your thumbs?\nlens.f90 creates a bunch of Postscript files as a result.\n\nWith Ghostscript you convert these Postscript files to PNGs.\n\n```py\nsubprocess.Popen(\n    [\n        \"gs\",\n        \"-dSAFER\",\n        \"-dEPSCrop\",\n        f\"-r150\",\n        \"-sDEVICE=pngalpha\",\n        \"-o\",\n        input.output_png_file,\n        input.output_ps_file,\n    ],\n)\n```\n\nAnd now you use ffmpeg to convert the PNGs to an MP4.\nGetting ffmpeg to spit out MP4s that can be played by anything other than VLC always takes some wiggling around.\nThis is what you come up with:\n\n```py\nsubprocess.Popen(\n    [\n        \"ffmpeg\",\n        \"-framerate\",\n        f\"30\",\n        \"-i\",\n        f\"./out/%03d.png\",\n        \"-vcodec\",\n        \"libx264\",\n        \"-f\",\n        \"mp4\",\n        \"-vb\",\n        \"1024k\",\n        \"-preset\",\n        \"slow\",\n        \"-pix_fmt\",\n        \"yuv420p\",\n        \"./out/lens.mp4\",\n    ],\n)\n```\n\nIf you'd been especially fancy you could've used more than two configuration vectors and a spline interpolation instead of the lerp.\nBut you already consumed all your fancyness on some over-engineered application-design with way too many structs, so you don't.\n\n# Conclusion\n\nWith the (patched) Fortran code, the *Dockerfile* and the Python script everyone can reproduce the compilation:\nCheck out the [Git Repo](https://github.com/christopher-besch/ctemsoft) and run Docker:\n```bash\ngit clone https://github.com/christopher-besch/ctemsoft\ncd ctemsoft\n# [edit python_src/main.py to your liking]\ndocker build -t chrisbesch/ctemsoft .\ndocker run -v ./out:/python_src/out chrisbesch/ctemsoft\nvlc out/lens.mp4\n```\nAnd now you have made an animated video out of decades old code in a language you don't know in a way people will be able to understand for decades to come.\n\nSo when you're creating something of your own consider creating a *Dockerfile* for that, too.\n\n{/* ffmpeg -i lens.mp4 -vf 'crop=1026:1437:144:187' lens_cropped.mp4 */}\n{/* ffmpeg -i lens_3_5.png -vf 'crop=1026:1437:144:187' lens_3_5_cropped.png */}\n","frontmatter":{"date":"Sunday, 6th April, 2025","title":"Docker: Breathing Life into Decades old Fortran","description":" Bringing decades old Fortran code to life with Docker and animating it with Python.\nNow you get to see Fig.3.5. from \"Introduction to Conventional Transmission Electron Microscopy\" by Prof. Marc De Graef at 30 frames a second. ","banner":"/social_banner/ctemsoft.png","title_banner":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","placeholder":{"fallback":"data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAQCAwX/xAAWAQEBAQAAAAAAAAAAAAAAAAACAAH/2gAMAwEAAhADEAAAAWJZFxTQgWf/xAAbEAADAAIDAAAAAAAAAAAAAAAAAQMCERITIf/aAAgBAQABBQLGsmZVmjukJe8dGj//xAAVEQEBAAAAAAAAAAAAAAAAAAAAEv/aAAgBAwEBPwGUv//EABURAQEAAAAAAAAAAAAAAAAAAAAS/9oACAECAQE/AbW//8QAGBAAAwEBAAAAAAAAAAAAAAAAAAEyEBH/2gAIAQEABj8CtFIo5v8A/8QAGxAAAgMBAQEAAAAAAAAAAAAAAAERIWExkbH/2gAIAQEAAT8hWfWhN2eWYPCZuIGiVND0f//aAAwDAQACAAMAAAAQs/8A/8QAFhEBAQEAAAAAAAAAAAAAAAAAAAER/9oACAEDAQE/EJLL/8QAFREBAQAAAAAAAAAAAAAAAAAAABH/2gAIAQIBAT8QpT//xAAeEAACAgEFAQAAAAAAAAAAAAABEQAxIUFxgaGx0f/aAAgBAQABPxAKQnoTdwkAQYy8R1u3fIIcUA8qGjWWbhHH/9k="},"images":{"fallback":{"src":"/static/5d4b9c5e9d53d28fa2aedc785041d70d/204db/alpha_victor.jpg","srcSet":"/static/5d4b9c5e9d53d28fa2aedc785041d70d/fa695/alpha_victor.jpg 480w,\n/static/5d4b9c5e9d53d28fa2aedc785041d70d/9f3ff/alpha_victor.jpg 960w,\n/static/5d4b9c5e9d53d28fa2aedc785041d70d/204db/alpha_victor.jpg 1920w","sizes":"(min-width: 1920px) 1920px, 100vw"},"sources":[{"srcSet":"/static/5d4b9c5e9d53d28fa2aedc785041d70d/95a23/alpha_victor.webp 480w,\n/static/5d4b9c5e9d53d28fa2aedc785041d70d/42d4c/alpha_victor.webp 960w,\n/static/5d4b9c5e9d53d28fa2aedc785041d70d/2136b/alpha_victor.webp 1920w","type":"image/webp","sizes":"(min-width: 1920px) 1920px, 100vw"}]},"width":1920,"height":1281}}},"title_banner_horizontal_position":"70%","title_banner_vertical_position":"70%","version":"1.0.0"}}},"pageContext":{"id":"2c6049b6-e20c-52b3-9e0f-6eff2560eb37","frontmatter":{"type":"article","title":"Docker: Breathing Life into Decades old Fortran","description":" Bringing decades old Fortran code to life with Docker and animating it with Python.\nNow you get to see Fig.3.5. from \"Introduction to Conventional Transmission Electron Microscopy\" by Prof. Marc De Graef at 30 frames a second. ","banner":"/social_banner/ctemsoft.png","thumb":"../../../static/social_banner/ctemsoft.png","title_banner":"../../images/photography/alpha_victor.jpg","title_banner_horizontal_position":"70%","title_banner_vertical_position":"70%","slug":"ctemsoft","date":"2025-04-06T00:00:00.000Z","listed":true,"version":"1.0.0"}}},"staticQueryHashes":["1995789189","2480137602","475732191"],"slicesMap":{}}